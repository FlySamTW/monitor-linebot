# v25.0.0 修復摘要

## 🔍 用戶回報的 5 大問題

### 1. ❌ M7 視訊鏡頭幻覺回答
**徵兆**
```
用戶：「M7有附視訊鏡頭嗎」
AI：「根據我的資料庫，M70D有內建視訊鏡頭喔！🎉」
實際：QA + CLASS_RULES 都沒寫 M7 有視訊鏡頭
```

**根本原因**
- Prompt 規則 「規格清單未提及=不支援」不夠嚴格
- AI 存在「類比推測」傾向：看到 M8 有視訊鏡頭 → 推測 M7 也有

**修復**（v25.0.0）
- Prompt.csv 第 42 行增強規則
- 新增明確禁條：「禁止類比推測。CLASS_RULES 沒寫就是沒有，誠實說『資料庫裡沒寫 M7 有視訊鏡頭』」

---

### 2. ❌ M8 視訊鏡頭使用方式 - 知識不一致
**徵兆**
```
第2輪：「m8有附視訊鏡頭嗎」
AI：「M80D有內建視訊鏡頭喔！」✅

第4輪：「我是指它的視訊鏡頭使用方式」
AI：「產品手冊中沒有關於視訊鏡頭使用方式的說明」❌
```

**根本原因**
- v24.5.8 型號汙染：直通車確定了 S32FM803，但還繼續從 KEYWORD_MAP 擴充
- exactModels 從 `[S32FM803]` 變成 `[S32FM803, M80D, M70D, ...]`
- 載入了 2 本 PDF，其中一本不相關

**修復**（v25.0.0）
- linebot.gs 新增 `hasInjectedModels` 標記
- 邏輯：直通車讀到型號後，跳過 KEYWORD_MAP 擴充步驟
- 結果：只注入 S32FM803，只載相關 PDF

---

### 3. ❌ 為什麼載了 2 本 PDF？
**原始日誌**
```
[KB Select] 從 Cache 讀取直通車注入型號: S32FM803 ✅
[KB Select] 🎯 命中型號: S32FM803, M80D, M70D, S32DM803UC, ... ❌
→ 載入 PDF: S32FM702,S32FM703,S32FM803.pdf + S27DM502,S32DG702,S32DG802,...
```

**修復前後對比**

| 項目 | v24.5.8 | v25.0.0 |
|------|---------|---------|
| exactModels | `[S32FM803, M80D, M70D, ...]` | `[S32FM803]` |
| 載入 PDF 數 | 2 本 | 1 本 |
| Input Tokens | ~114K | ~55-65K (預期) |

**修復邏輯**
```javascript
// v25.0.0 新增
let hasInjectedModels = false;
if (injectedModels from Cache) {
    hasInjectedModels = true;  // ← 標記
}

// 跳過 KEYWORD_MAP 擴充
if (!hasInjectedModels) {
    // 掃 KEYWORD_MAP
}
```

---

### 4. ❌ 有手冊為什麼找不到視訊鏡頭使用方式？

**可能性分析**

| 可能性 | 描述 | 確認方法 |
|--------|------|---------|
| 手冊沒寫 | S32FM803 手冊確實沒有視訊鏡頭操作步驟 | 檢查實體手冊 / PDF 內容 |
| PDF 載入錯誤 | v24.5.8 時載入了不相關的 PDF，遮掩了正確內容 | v25.0.0 後重新測試 |
| AI 提取失敗 | PDF 有但 AI 的 extended thinking 提取失敗 | 查看 AI 回答邏輯 |

**v25.0.0 後預期**
- 只載 S32FM803 相關 PDF（正確版本）
- 若手冊有 → AI 應找到並清晰回答
- 若手冊無 → AI 應誠實說「手冊未記載」

---

### 5. ❌ 計費是否正常？
**原始統計**
```
[Tokens] In: 114544, Out: 38, Total: 114582 (約 NT$0.3670)
```

**成本分析**
```
Input:  114544 × $0.10 / 1M = $0.01145
Output: 38 × $0.40 / 1M = $0.000015
Total: ~$0.0115 (NT$0.3450)  ← 官方顯示 0.3670 有誤差

過度成本來源：
- 載 2 本 PDF 導致 input tokens 增加 ~50%
- 應該只需 ~55-65K tokens（節省 $0.12）
```

**v25.0.0 修復後**
- 預期 input tokens: ~55-65K（vs 114K）
- 預期成本: ~NT$0.18-0.22（節省 $0.12 以上）

---

## 📋 修復清單

### ✅ 已完成
- [x] v25.0.0 linebot.gs：型號汙染修復（hasInjectedModels 標記）
- [x] v25.0.0 Prompt.csv：禁止類比推測（M7 ≠ M8）

### ⏳ 待驗證
- [ ] 實測用戶問「m8視訊鏡頭怎麼用」，確認只載 1 本 PDF
- [ ] 確認 input tokens 從 114K 降至 55-65K
- [ ] 確認成本從 NT$0.37 降至 NT$0.18-0.22
- [ ] 驗證手冊是否確實有 M8 視訊鏡頭操作步驟

---

## 🚀 部署步驟

```bash
# 1. 將最新版本推送至 GAS
clasp push -f

# 2. 在 LINE 中測試
msg: "m8的視訊鏡頭怎麼用呢"

# 3. 檢查日誌
[KB Select] 🎯 命中型號: S32FM803 → 載入 PDF: S32FM803...
[Tokens] In: ~60000, Out: xxx, Total: ~60xxx
```

---

## 📝 版本記錄

### v25.0.0 (2025/12/08)
**修復**
- 型號汙染問題：直通車確定型號後不再從 KEYWORD_MAP 擴充
- 規格規範強化：禁止類比推測，CLASS_RULES 沒寫就是沒有

**成果**
- 降低不必要 PDF 載入
- 預期節省 50% token（114K → 55-65K）
- 預期節省成本 $0.12 以上
