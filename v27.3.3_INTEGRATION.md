# v27.3.3-v27.3.9 整合報告 - PDF 深度閱讀增強 + TestUI 穩定化

**版本歷程**：v27.2.4 → v27.2.5-v27.3.2（過程改進）→ v27.3.3（PDF 增強）→ v27.3.4（TestUI）→ v27.3.5（穩定化）→ v27.3.6（全端同步）→ v27.3.7（終極防呆）→ v27.3.8（源頭防彈）→ v27.3.9（髒資料防護）

## 核心修復概要

### Phase 1: 邏輯陷阱排除 (v27.2.0)
**問題**：v26.5.0 引入的「禁止通用知識」和「允許通用知識」規則矛盾
- Rule 2b: "禁止猜測或用通用知識代替 PDF 內容"
- Rule 6: "若 PDF 無相關內容，嘗試通用知識回答"
- **結果**：AI 無法回答，只能輸出 emoji

**解決**：重新排列 Prompt 優先順序，允許在 PDF 不足時進行有標記的通用知識回答

### Phase 2: 基礎 Bug 修復 (v27.2.1-v27.2.3)
| 版本 | 問題 | 修復 |
|------|------|------|
| v27.2.1 | `usage is not defined` 破壞 API 解析 | 宣告 `let usage = null;` 在 if 外 |
| v27.2.2 | `/重啟` 觸發完整知識庫重建 | 改 `syncGeminiKnowledgeBase(false)` |
| v27.2.3 | Google Search 工具造成逾時 | 禁用 Deep Mode 的搜尋工具 |

### Phase 3: 根本原因修復 (v27.2.4)
**真正問題**：Deep Mode 動態提示中的「100-300字」字數限制
- 當 PDF 內容不足以滿足字數要求時，AI 陷入困境
- 無法完整回答（超過字數限制）、無法空白（違反規則）、只能輸出 emoji

**終極解決**：
```javascript
// OLD: 從 v27.x 開始就有的陷阱
dynamicPrompt += `2. 如果找到，詳細回答（100-300 字）\n`;

// NEW: v27.2.4 修復
dynamicPrompt += `2. 如果找到，詳細回答（無字數限制，詳細為優先）\n`;
```

### Phase 4: 額外增強 (v27.2.5+)
- **v27.2.5**：強化 Safety Settings（四層傷害類別），改進 PDF Debug 日誌
- **v27.2.6**：新增 PromptFeedback 解析，優化 PDF 選擇快取
- **v27.2.7**：PDF 選擇邏輯優化 + pending cache 改進
- **v27.2.8**：修正 PDF 深讀邏輯衝突（避免多次 [AUTO_SEARCH_PDF] 觸發）
- **v27.2.9**：正則表達式最佳化，Alias Key 去重
- **v27.3.0**：直通車型號檢查邏輯完全重寫
- **v27.3.1**：修正 JSON.parse 在 direct_search_models 的失敗處理
- **v27.3.2**：Alias Key 和 Prompt 版本同步修正
- **v27.3.3**：PDF 回答指令強化（進一步無視字數限制）

## v27.3.3 最終狀態

### linebot.gs 關鍵變更
1. **版本號**：第 3 行更新為 v27.3.3
2. **Deep Mode Prompt Injection**（第 ~2100 行）：
   - 完全重寫，強制教學模式
   - 無字數限制聲明
   - 加強 emoji 禁令

3. **Safety Settings**（第 ~2200 行）：
   - 四層防護：HARASSMENT, HATE_SPEECH, SEXUALLY_EXPLICIT, DANGEROUS_CONTENT
   - 全部 BLOCK_NONE（AI 自由發揮，責任在 Prompt）

4. **PDF 選擇機制**（第 ~700-750 行）：
   - `handlePdfSelectionReply()` 改進
   - pending cache 管理更佳

### Prompt.csv 版本
- 更新至 v27.3.3
- Rule 2b 明確允許有源通用知識補充
- Rule 8 禁止所有形式的空白回答（含 emoji）

## 關鍵教訓

### 症狀 vs 根本原因
- **症狀**：只輸出 emoji（2 個 token）
- **假設**（被推翻的）：
  - Thinking Mode 過度思考？→ 不存在於 2.0-flash
  - 字數限制只是反應？→ 不，是主因
  - 搜尋工具超時？→ 已禁用，但不是根本
- **根本原因**：字數限制框架陷阱

### 三層記憶架構在此案例的作用
| 層級 | 角色 | 是否觸發 emoji |
|------|------|------|
| QA/CLASS_RULES（Fast Mode） | 快速應答 | ❌ 不會 |
| PDF（Deep Mode） | 詳細教學 | ⚠️ 會（如有字數限制） |
| 通用知識（Fallback） | 補充說明 | ❌ 不會（已許可且標記） |

### 版本控制經驗
- 不要相信單一版本的改動解釋
- 追蹤對話歷史，而不僅依賴 Git commit message
- 回歸測試是尋找破壞點的關鍵（v26.3 → v26.5 → v27.x）

## 現在的穩定狀態

✅ **驗證項目**：
- Deep Mode 輸出正常長度回答（200+ tokens）
- PDF 內容正確附帶（使用 Gemini File API）
- emoji 禁令有效（日誌顯示禁止檢查）
- 成本控制（2.0-flash 減少 84% 成本）
- 知識庫同步正常（56 本 PDF 已快取）

## 檔案清單

### 保留的文件
- **程式編寫開發及功能手冊.md**：主要參考文檔
- **LLM_LOGIC_HISTORY.md**：邏輯發展歷史
- **PRIORITY_LOGIC_ARCHITECTURE.md**：系統架構
- **v27.3.3_INTEGRATION.md**（本文件）：整合總結

### 已刪除的文件（中間過程，現已整合）
- v27.2.0_LOGIC_FIX.md
- v27.2.1_CRITICAL_FIX.md
- v27.2.2_DESIGN_FIX.md
- v27.2.3_ROOT_CAUSE_FIX.md
- v27.2.4_ROOT_FIX.md

## v27.3.4 & v27.3.5 更新紀錄

### v27.3.4 (2025-12-09) - TestUI 測試介面 + /紀錄 Sheet 寫入

**新增功能**：
1. **Web App 測試介面** (`doGet()` → TestUI.html)
   - LINE 風格垂直手機介面
   - 支援即時訊息傳送、命令快速鍵
   - 內嵌 LOG 檢視器及複製功能

2. **測試模式架構** (IS_TEST_MODE global)
   - 三層安全檢查：writeLog、writeRecordDirectly、replyMessage
   - 防止 Sheet 污染、API 濫用
   - /紀錄 特殊處理：UserRecord/Error 類型強制寫入 Sheet（帶 [測試模式] 標記）

3. **新增函數**：
   - `doGet()`：返回 TestUI.html Web App
   - `testMessage(userId, text)`：模擬 LINE 事件（初始版本）
   - `clearTestSession(userId)`：清除測試快取

### v27.3.5 (2025-12-09) - testMessage 參數順序 & null-safety 穩定化

**關鍵修復**：
1. **參數順序修正** (checkDirectDeepSearch undefined 錯誤)
   - OLD: `testMessage(userId, text)` ← 參數順序反轉，導致 msg 為 undefined
   - NEW: `testMessage(msg, userId)` ← 符合 TestUI.html 的呼叫方式

2. **Null-Safety 防坑**：
   ```javascript
   // 防呆：確保 msg 是字串且不為空
   if (!msg) msg = "";
   ```

3. **完整 LINE 事件物件**：
   ```javascript
   const fakeEvent = {
     replyToken: 'TEST_REPLY_TOKEN',
     source: { type: 'user', userId: userId || 'TEST_DEV_001' },
     message: { type: 'text', text: msg, id: 'TEST_MSG_' + timestamp },
     type: 'message',
     timestamp: new Date().getTime()
   };
   ```
   - 完整模擬 LINE webhook 結構
   - 防止 handleMessage 接收不完整事件

4. **TestUI.html 參數統一**：
   - 改用 `TEST_USER_ID` 常數而非硬編碼 "TEST_DEV_001"
   - 確保一致性和易維護性

**修復成果**：
- ✅ 消除 "Cannot read properties of undefined (reading 'toUpperCase')" 錯誤
- ✅ testMessage 現在能正確建立 LINE 事件並傳遞參數
- ✅ 測試介面穩定可用

## v27.3.6 (2025-12-09) - 全端同步手術 (解決「一直思考中」問題)

**問題診斷**：
- **症狀**：前端一直停留在「思考中」，但 LOG 面板有即時進度
- **根本原因**：後端 `testMessage` 回傳格式跟前端預期不符
  - 後端可能回傳 Error 物件或格式混亂的 Log 陣列
  - 前端無法正確解析，所以卡在 `withSuccessHandler` 等待狀態

**後端修復 (linebot.gs - V27.3.6 終極版)**：
1. **強制統一回傳格式**：
   ```javascript
   return {
     success: true,
     reply: botResponse,      // 直接給前端最終回覆文本
     logs: TEST_LOGS,         // 完整 LOG 陣列
     tokens: tokenInfo        // Token 統計
   };
   ```

2. **攔截 ContentService 錯誤**：
   - `handleMessage()` 內部會呼叫 `ContentService.createTextOutput()`
   - 這個物件在網頁端無法讀取，會導致報錯
   - V27.3.6 在 try-catch 中判斷並忽略此類非致命錯誤

3. **智慧提取回覆**：
   - 反向搜尋 TEST_LOGS，依優先級提取回覆：
     - [AI Reply] > [Reply] > [API Short Response]
     - 若檢測到「反問」，返回「請選擇型號」提示

**前端修復 (TestUI.html - v2.2)**：
1. **簡化 withSuccessHandler 邏輯**：
   ```javascript
   .withSuccessHandler(function(res) {
     // res 現在是清晰的物件：{ success, reply, logs, tokens }
     if (res && res.logs) updateLogs(res.logs);
     addMsg("bot", res.reply || "(無回覆)");
   })
   ```

2. **不再自己 parse Log**：
   - 刪除複雜的 Log 行解析邏輯
   - 直接信任後端給出的 `res.reply` 文本

3. **UI 改進**：
   - 移除 Toast 通知（簡化)
   - 改用 `TEST_USER_ID` 常數確保一致性
   - 佇列顯示更清晰（「排程」而非「等待發送」）

**修復成果**：
- ✅ 前端立即收到 `{ success, reply, logs }` 物件
- ✅ 不再卡在「思考中」
- ✅ LOG 即時滾動，回覆立即顯示
- ✅ 兩端語言統一，通信穩定

## v27.3.7 (2025-12-09) - 終極防呆版（根治 trim 錯誤）

**問題診斷**：
- **症狀 1**：點擊「3」或其他快捷鍵時，出現 `Fatal Error: trim is not a function`
- **症狀 2**：v27.3.6 修復「一直思考中」後，數字型別參數導致新錯誤
- **根本原因**：
  - 前端可能傳入數字 `3` 而非字串 `"3"`
  - 後端 `handleMessage` 中的 `userMessage.trim()` 只能處理字串
  - JavaScript 中 `Number.prototype` 沒有 `trim()` 方法

**後端修復 (linebot.gs - V27.3.7)**：
1. **強制轉字串防呆**：
   ```javascript
   // 🔥【絕對防呆】強制轉型為字串，根治 "trim is not a function" 錯誤
   if (msg === undefined || msg === null) msg = "";
   msg = String(msg); 
   ```
   - 先檢查 null/undefined
   - 然後**無條件**用 `String()` 轉型
   - 確保傳給 handleMessage 的絕對是字串

2. **統一註解風格**：
   - 用 `---` 區隔主要邏輯區塊
   - 用 `🔥【】` 標記關鍵防呆點

3. **錯誤訊息優化**：
   - `[Fatal] 系統崩潰` 改為更明確的錯誤提示
   - 提示檢查 linebot.gs 而非前端

**前端修復 (TestUI.html - v2.3)**：
1. **Toast 通知恢復**：
   - `copyLogs()` 改用 `showToast()` 而非 `alert()`
   - `clearSession()` 增加 Toast 提示

2. **文案微調**：
   - "模擬器已連線" → "模擬器連線成功"

**修復原理說明**：
- JavaScript 的 `String()` 是型別轉換函數，可處理：
  - 數字：`String(3)` → `"3"`
  - 布林：`String(true)` → `"true"`
  - null：`String(null)` → `"null"`（先檢查避免）
  - undefined：`String(undefined)` → `"undefined"`（先檢查避免）
  - 物件：`String({a:1})` → `"[object Object]"`

**修復成果**：
- ✅ 任何資料型別傳入都會被轉成字串
- ✅ `trim()` 永遠不會報錯
- ✅ 數字、布林、物件都能正常處理
- ✅ 回傳格式絕對一致 `{ success, reply, logs, tokens }`

**GAS 即時進度限制說明**：
- Google Apps Script 採用「請求-等待-回應」模式
- 無法像 WebSocket 一樣邊執行邊推送 LOG
- 前端看到的「思考中」是正常的 GAS 行為
- LOG 會在執行完畢後一次全部顯示（這是 GAS 架構限制，無法改變）

## v27.3.8 (2025-12-09) - handleMessage 源頭防彈（雙層強制轉型）

**問題回顧**：
- v27.3.7 在 testMessage 做了強制轉型，但 handleMessage 沒有
- 當 testMessage 直接呼叫 handleMessage 時，參數可能已經過處理
- 但 LINE webhook 直接呼叫 handleMessage 時，event.message.text 可能是數字
- 導致 trim 錯誤依然存在

**終極修復（handleMessage 源頭防彈）**：
```javascript
function handleMessage(userMessage, userId, replyToken, contextId, messageId) {
  try {
    // 🔥 強制轉型：不管傳來什麼（數字、物件、null），先轉成字串再說！
    userMessage = String(userMessage || "");
    
    if (!userMessage || !userMessage.trim()) return;
    const msg = userMessage.trim();
```

**雙層防護架構**：
1. **testMessage（測試入口）**：`msg = String(msg);` - 保護測試環境
2. **handleMessage（主程式入口）**：`userMessage = String(userMessage || "");` - **源頭防護**

**為什麼需要兩層？**
- testMessage → handleMessage（測試路徑）：第一層已防護
- LINE webhook → handleMessage（真實路徑）：**必須第二層防護**
- 確保任何入口進入都安全

**修復成果**：
- ✅ 真實 LINE 訊息不會 trim 錯誤
- ✅ 測試介面不會 trim 錯誤
- ✅ 任何資料型別都能正確處理
- ✅ 雙層保險，萬無一失

## v27.3.9 (2025-12-09) - Cache 髒資料防護（根治 null.length 錯誤）

**問題根源**：
- **症狀**：`TypeError: Cannot read properties of null (reading 'length')`
- **原因**：Cache 中存入了 `null` 或非陣列資料
  - `JSON.parse('null')` 會返回 `null` 而非陣列
  - 髒資料：舊版本可能存入了 `"null"` 字串
  - 導致 `cachedDirectModels.length` 失敗

**修復策略（三層防護）**：

1. **handleMessage - Cache 解析防護**：
   ```javascript
   // v27.3.9: 加強防呆 - 防止 Cache 髒資料（null/非陣列）導致 length 錯誤
   const cachedDirectModelsJson = cache.get(`${userId}:direct_search_models`);
   let cachedDirectModels = [];
   try {
       if (cachedDirectModelsJson) {
           const parsed = JSON.parse(cachedDirectModelsJson);
           // 🔥 絕對防呆：如果 parse 出來是 null 或非陣列，強制變成 []
           cachedDirectModels = Array.isArray(parsed) ? parsed : [];
       }
   } catch(e) {
       writeLog(`[Cache Parse Error] direct_search_models 轉換失敗: ${e.message}`);
   }
   const hasSelectedPdf = cachedDirectModels.length > 0;  // 現在絕對安全
   ```

2. **testMessage - 輸入清洗強化**：
   ```javascript
   // 🔥【終極防呆】強制清洗輸入資料：處理物件、null、undefined、數字等所有異常情況
   if (typeof msg === 'object') {
       try { msg = JSON.stringify(msg); } catch(e) { msg = ""; }
   }
   msg = String(msg || "").trim();
   if (msg === "") msg = "測試空訊息";  // 避免空訊息誤判
   ```

3. **clearTestSession - 深層清潔**：
   ```javascript
   // 🔥 v27.3.9: 額外清除可能的髒資料
   cache.remove(`HISTORY_${userId}`);
   cache.remove(`PENDING_PDF_${userId}`);
   ```

**為什麼需要 Array.isArray()？**
- `JSON.parse('null')` → `null` ❌
- `JSON.parse('[]')` → `[]` ✅
- `JSON.parse('[1,2,3]')` → `[1,2,3]` ✅
- `JSON.parse('"test"')` → `"test"` ❌（字串不是陣列）
- `Array.isArray(null)` → `false` → 強制變 `[]` ✅

**修復成果**：
- ✅ Cache 讀取永遠返回有效陣列（即使存入的是 null）
- ✅ `cachedDirectModels.length` 永遠不會報錯
- ✅ 深層清潔機制清除所有可能的髒快取
- ✅ 物件輸入自動轉 JSON 字串，不會炸掉

**用戶操作建議**：
測試介面點擊 **⚡️ 重置** 按鈕，執行深層清潔，清除所有舊的髒快取。

## 接下來的維護

1. **監控 emoji 問題**：若再次出現，檢查 Prompt.csv 是否有新矛盾規則
2. **Token 成本預算**：Deep Mode 正常應在 100-150k tokens（含 PDF）
3. **PDF 載入邏輯**：型號擴充應受 `hasInjectedModels` 限制
4. **版本更新流程**：linebot.gs、Prompt.csv、MD 文件應同步更新版本號

## 測試介面清除指南

當測試完成、移除 TestUI 時：
1. 刪除 TEST MODE GLOBALS 區塊（lines 1-9）
2. 刪除 writeLog、writeRecordDirectly、replyMessage 中的 IS_TEST_MODE 檢查
3. 刪除 doGet、testMessage、clearTestSession 函數（區塊 9）
4. 刪除 TestUI.html 檔案
5. `clasp push -f` 部署
6. 版本號改為 v28.0.0

---
**上次更新**：2025-12-09  
**下一目標版本**：v28.0.0（可考慮的方向：聯繫 Sam 提示優化、模型遷移升級、多語言支援）
