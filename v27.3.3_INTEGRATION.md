# v27.3.3-v27.4.1 æ•´åˆå ±å‘Š - PDF æ·±åº¦é–±è®€å¢å¼· + TestUI ç©©å®šåŒ– + æœ€çµ‚ä¿®æ­£

**ç‰ˆæœ¬æ­·ç¨‹**ï¼šv27.2.4 â†’ v27.2.5-v27.3.2ï¼ˆéç¨‹æ”¹é€²ï¼‰â†’ v27.3.3ï¼ˆPDF å¢å¼·ï¼‰â†’ v27.3.4ï¼ˆTestUIï¼‰â†’ v27.3.5ï¼ˆç©©å®šåŒ–ï¼‰â†’ v27.3.6ï¼ˆå…¨ç«¯åŒæ­¥ï¼‰â†’ v27.3.7ï¼ˆçµ‚æ¥µé˜²å‘†ï¼‰â†’ v27.3.8ï¼ˆæºé ­é˜²å½ˆï¼‰â†’ v27.3.9ï¼ˆé«’è³‡æ–™é˜²è­·ï¼‰â†’ v27.4.0ï¼ˆæ ¸å½ˆç´šé˜²ç¦¦ï¼‰â†’ v27.4.1ï¼ˆæœ€çµ‚ä¿®æ­£ï¼‰

## æ ¸å¿ƒä¿®å¾©æ¦‚è¦

### Phase 1: é‚è¼¯é™·é˜±æ’é™¤ (v27.2.0)
**å•é¡Œ**ï¼šv26.5.0 å¼•å…¥çš„ã€Œç¦æ­¢é€šç”¨çŸ¥è­˜ã€å’Œã€Œå…è¨±é€šç”¨çŸ¥è­˜ã€è¦å‰‡çŸ›ç›¾
- Rule 2b: "ç¦æ­¢çŒœæ¸¬æˆ–ç”¨é€šç”¨çŸ¥è­˜ä»£æ›¿ PDF å…§å®¹"
- Rule 6: "è‹¥ PDF ç„¡ç›¸é—œå…§å®¹ï¼Œå˜—è©¦é€šç”¨çŸ¥è­˜å›ç­”"
- **çµæœ**ï¼šAI ç„¡æ³•å›ç­”ï¼Œåªèƒ½è¼¸å‡º emoji

**è§£æ±º**ï¼šé‡æ–°æ’åˆ— Prompt å„ªå…ˆé †åºï¼Œå…è¨±åœ¨ PDF ä¸è¶³æ™‚é€²è¡Œæœ‰æ¨™è¨˜çš„é€šç”¨çŸ¥è­˜å›ç­”

### Phase 2: åŸºç¤ Bug ä¿®å¾© (v27.2.1-v27.2.3)
| ç‰ˆæœ¬ | å•é¡Œ | ä¿®å¾© |
|------|------|------|
| v27.2.1 | `usage is not defined` ç ´å£ API è§£æ | å®£å‘Š `let usage = null;` åœ¨ if å¤– |
| v27.2.2 | `/é‡å•Ÿ` è§¸ç™¼å®Œæ•´çŸ¥è­˜åº«é‡å»º | æ”¹ `syncGeminiKnowledgeBase(false)` |
| v27.2.3 | Google Search å·¥å…·é€ æˆé€¾æ™‚ | ç¦ç”¨ Deep Mode çš„æœå°‹å·¥å…· |

### Phase 3: æ ¹æœ¬åŸå› ä¿®å¾© (v27.2.4)
**çœŸæ­£å•é¡Œ**ï¼šDeep Mode å‹•æ…‹æç¤ºä¸­çš„ã€Œ100-300å­—ã€å­—æ•¸é™åˆ¶
- ç•¶ PDF å…§å®¹ä¸è¶³ä»¥æ»¿è¶³å­—æ•¸è¦æ±‚æ™‚ï¼ŒAI é™·å…¥å›°å¢ƒ
- ç„¡æ³•å®Œæ•´å›ç­”ï¼ˆè¶…éå­—æ•¸é™åˆ¶ï¼‰ã€ç„¡æ³•ç©ºç™½ï¼ˆé•åè¦å‰‡ï¼‰ã€åªèƒ½è¼¸å‡º emoji

**çµ‚æ¥µè§£æ±º**ï¼š
```javascript
// OLD: å¾ v27.x é–‹å§‹å°±æœ‰çš„é™·é˜±
dynamicPrompt += `2. å¦‚æœæ‰¾åˆ°ï¼Œè©³ç´°å›ç­”ï¼ˆ100-300 å­—ï¼‰\n`;

// NEW: v27.2.4 ä¿®å¾©
dynamicPrompt += `2. å¦‚æœæ‰¾åˆ°ï¼Œè©³ç´°å›ç­”ï¼ˆç„¡å­—æ•¸é™åˆ¶ï¼Œè©³ç´°ç‚ºå„ªå…ˆï¼‰\n`;
```

### Phase 4: é¡å¤–å¢å¼· (v27.2.5+)
- **v27.2.5**ï¼šå¼·åŒ– Safety Settingsï¼ˆå››å±¤å‚·å®³é¡åˆ¥ï¼‰ï¼Œæ”¹é€² PDF Debug æ—¥èªŒ
- **v27.2.6**ï¼šæ–°å¢ PromptFeedback è§£æï¼Œå„ªåŒ– PDF é¸æ“‡å¿«å–
- **v27.2.7**ï¼šPDF é¸æ“‡é‚è¼¯å„ªåŒ– + pending cache æ”¹é€²
- **v27.2.8**ï¼šä¿®æ­£ PDF æ·±è®€é‚è¼¯è¡çªï¼ˆé¿å…å¤šæ¬¡ [AUTO_SEARCH_PDF] è§¸ç™¼ï¼‰
- **v27.2.9**ï¼šæ­£å‰‡è¡¨é”å¼æœ€ä½³åŒ–ï¼ŒAlias Key å»é‡
- **v27.3.0**ï¼šç›´é€šè»Šå‹è™Ÿæª¢æŸ¥é‚è¼¯å®Œå…¨é‡å¯«
- **v27.3.1**ï¼šä¿®æ­£ JSON.parse åœ¨ direct_search_models çš„å¤±æ•—è™•ç†
- **v27.3.2**ï¼šAlias Key å’Œ Prompt ç‰ˆæœ¬åŒæ­¥ä¿®æ­£
- **v27.3.3**ï¼šPDF å›ç­”æŒ‡ä»¤å¼·åŒ–ï¼ˆé€²ä¸€æ­¥ç„¡è¦–å­—æ•¸é™åˆ¶ï¼‰

## v27.3.3 æœ€çµ‚ç‹€æ…‹

### linebot.gs é—œéµè®Šæ›´
1. **ç‰ˆæœ¬è™Ÿ**ï¼šç¬¬ 3 è¡Œæ›´æ–°ç‚º v27.3.3
2. **Deep Mode Prompt Injection**ï¼ˆç¬¬ ~2100 è¡Œï¼‰ï¼š
   - å®Œå…¨é‡å¯«ï¼Œå¼·åˆ¶æ•™å­¸æ¨¡å¼
   - ç„¡å­—æ•¸é™åˆ¶è²æ˜
   - åŠ å¼· emoji ç¦ä»¤

3. **Safety Settings**ï¼ˆç¬¬ ~2200 è¡Œï¼‰ï¼š
   - å››å±¤é˜²è­·ï¼šHARASSMENT, HATE_SPEECH, SEXUALLY_EXPLICIT, DANGEROUS_CONTENT
   - å…¨éƒ¨ BLOCK_NONEï¼ˆAI è‡ªç”±ç™¼æ®ï¼Œè²¬ä»»åœ¨ Promptï¼‰

4. **PDF é¸æ“‡æ©Ÿåˆ¶**ï¼ˆç¬¬ ~700-750 è¡Œï¼‰ï¼š
   - `handlePdfSelectionReply()` æ”¹é€²
   - pending cache ç®¡ç†æ›´ä½³

### Prompt.csv ç‰ˆæœ¬
- æ›´æ–°è‡³ v27.3.3
- Rule 2b æ˜ç¢ºå…è¨±æœ‰æºé€šç”¨çŸ¥è­˜è£œå……
- Rule 8 ç¦æ­¢æ‰€æœ‰å½¢å¼çš„ç©ºç™½å›ç­”ï¼ˆå« emojiï¼‰

## é—œéµæ•™è¨“

### ç—‡ç‹€ vs æ ¹æœ¬åŸå› 
- **ç—‡ç‹€**ï¼šåªè¼¸å‡º emojiï¼ˆ2 å€‹ tokenï¼‰
- **å‡è¨­**ï¼ˆè¢«æ¨ç¿»çš„ï¼‰ï¼š
  - Thinking Mode éåº¦æ€è€ƒï¼Ÿâ†’ ä¸å­˜åœ¨æ–¼ 2.0-flash
  - å­—æ•¸é™åˆ¶åªæ˜¯åæ‡‰ï¼Ÿâ†’ ä¸ï¼Œæ˜¯ä¸»å› 
  - æœå°‹å·¥å…·è¶…æ™‚ï¼Ÿâ†’ å·²ç¦ç”¨ï¼Œä½†ä¸æ˜¯æ ¹æœ¬
- **æ ¹æœ¬åŸå› **ï¼šå­—æ•¸é™åˆ¶æ¡†æ¶é™·é˜±

### ä¸‰å±¤è¨˜æ†¶æ¶æ§‹åœ¨æ­¤æ¡ˆä¾‹çš„ä½œç”¨
| å±¤ç´š | è§’è‰² | æ˜¯å¦è§¸ç™¼ emoji |
|------|------|------|
| QA/CLASS_RULESï¼ˆFast Modeï¼‰ | å¿«é€Ÿæ‡‰ç­” | âŒ ä¸æœƒ |
| PDFï¼ˆDeep Modeï¼‰ | è©³ç´°æ•™å­¸ | âš ï¸ æœƒï¼ˆå¦‚æœ‰å­—æ•¸é™åˆ¶ï¼‰ |
| é€šç”¨çŸ¥è­˜ï¼ˆFallbackï¼‰ | è£œå……èªªæ˜ | âŒ ä¸æœƒï¼ˆå·²è¨±å¯ä¸”æ¨™è¨˜ï¼‰ |

### ç‰ˆæœ¬æ§åˆ¶ç¶“é©—
- ä¸è¦ç›¸ä¿¡å–®ä¸€ç‰ˆæœ¬çš„æ”¹å‹•è§£é‡‹
- è¿½è¹¤å°è©±æ­·å²ï¼Œè€Œä¸åƒ…ä¾è³´ Git commit message
- å›æ­¸æ¸¬è©¦æ˜¯å°‹æ‰¾ç ´å£é»çš„é—œéµï¼ˆv26.3 â†’ v26.5 â†’ v27.xï¼‰

## ç¾åœ¨çš„ç©©å®šç‹€æ…‹

âœ… **é©—è­‰é …ç›®**ï¼š
- Deep Mode è¼¸å‡ºæ­£å¸¸é•·åº¦å›ç­”ï¼ˆ200+ tokensï¼‰
- PDF å…§å®¹æ­£ç¢ºé™„å¸¶ï¼ˆä½¿ç”¨ Gemini File APIï¼‰
- emoji ç¦ä»¤æœ‰æ•ˆï¼ˆæ—¥èªŒé¡¯ç¤ºç¦æ­¢æª¢æŸ¥ï¼‰
- æˆæœ¬æ§åˆ¶ï¼ˆ2.0-flash æ¸›å°‘ 84% æˆæœ¬ï¼‰
- çŸ¥è­˜åº«åŒæ­¥æ­£å¸¸ï¼ˆ56 æœ¬ PDF å·²å¿«å–ï¼‰

## æª”æ¡ˆæ¸…å–®

### ä¿ç•™çš„æ–‡ä»¶
- **ç¨‹å¼ç·¨å¯«é–‹ç™¼åŠåŠŸèƒ½æ‰‹å†Š.md**ï¼šä¸»è¦åƒè€ƒæ–‡æª”
- **LLM_LOGIC_HISTORY.md**ï¼šé‚è¼¯ç™¼å±•æ­·å²
- **PRIORITY_LOGIC_ARCHITECTURE.md**ï¼šç³»çµ±æ¶æ§‹
- **v27.3.3_INTEGRATION.md**ï¼ˆæœ¬æ–‡ä»¶ï¼‰ï¼šæ•´åˆç¸½çµ

### å·²åˆªé™¤çš„æ–‡ä»¶ï¼ˆä¸­é–“éç¨‹ï¼Œç¾å·²æ•´åˆï¼‰
- v27.2.0_LOGIC_FIX.md
- v27.2.1_CRITICAL_FIX.md
- v27.2.2_DESIGN_FIX.md
- v27.2.3_ROOT_CAUSE_FIX.md
- v27.2.4_ROOT_FIX.md

## v27.3.4 & v27.3.5 æ›´æ–°ç´€éŒ„

### v27.3.4 (2025-12-09) - TestUI æ¸¬è©¦ä»‹é¢ + /ç´€éŒ„ Sheet å¯«å…¥

**æ–°å¢åŠŸèƒ½**ï¼š
1. **Web App æ¸¬è©¦ä»‹é¢** (`doGet()` â†’ TestUI.html)
   - LINE é¢¨æ ¼å‚ç›´æ‰‹æ©Ÿä»‹é¢
   - æ”¯æ´å³æ™‚è¨Šæ¯å‚³é€ã€å‘½ä»¤å¿«é€Ÿéµ
   - å…§åµŒ LOG æª¢è¦–å™¨åŠè¤‡è£½åŠŸèƒ½

2. **æ¸¬è©¦æ¨¡å¼æ¶æ§‹** (IS_TEST_MODE global)
   - ä¸‰å±¤å®‰å…¨æª¢æŸ¥ï¼šwriteLogã€writeRecordDirectlyã€replyMessage
   - é˜²æ­¢ Sheet æ±¡æŸ“ã€API æ¿«ç”¨
   - /ç´€éŒ„ ç‰¹æ®Šè™•ç†ï¼šUserRecord/Error é¡å‹å¼·åˆ¶å¯«å…¥ Sheetï¼ˆå¸¶ [æ¸¬è©¦æ¨¡å¼] æ¨™è¨˜ï¼‰

3. **æ–°å¢å‡½æ•¸**ï¼š
   - `doGet()`ï¼šè¿”å› TestUI.html Web App
   - `testMessage(userId, text)`ï¼šæ¨¡æ“¬ LINE äº‹ä»¶ï¼ˆåˆå§‹ç‰ˆæœ¬ï¼‰
   - `clearTestSession(userId)`ï¼šæ¸…é™¤æ¸¬è©¦å¿«å–

### v27.3.5 (2025-12-09) - testMessage åƒæ•¸é †åº & null-safety ç©©å®šåŒ–

**é—œéµä¿®å¾©**ï¼š
1. **åƒæ•¸é †åºä¿®æ­£** (checkDirectDeepSearch undefined éŒ¯èª¤)
   - OLD: `testMessage(userId, text)` â† åƒæ•¸é †åºåè½‰ï¼Œå°è‡´ msg ç‚º undefined
   - NEW: `testMessage(msg, userId)` â† ç¬¦åˆ TestUI.html çš„å‘¼å«æ–¹å¼

2. **Null-Safety é˜²å‘**ï¼š
   ```javascript
   // é˜²å‘†ï¼šç¢ºä¿ msg æ˜¯å­—ä¸²ä¸”ä¸ç‚ºç©º
   if (!msg) msg = "";
   ```

3. **å®Œæ•´ LINE äº‹ä»¶ç‰©ä»¶**ï¼š
   ```javascript
   const fakeEvent = {
     replyToken: 'TEST_REPLY_TOKEN',
     source: { type: 'user', userId: userId || 'TEST_DEV_001' },
     message: { type: 'text', text: msg, id: 'TEST_MSG_' + timestamp },
     type: 'message',
     timestamp: new Date().getTime()
   };
   ```
   - å®Œæ•´æ¨¡æ“¬ LINE webhook çµæ§‹
   - é˜²æ­¢ handleMessage æ¥æ”¶ä¸å®Œæ•´äº‹ä»¶

4. **TestUI.html åƒæ•¸çµ±ä¸€**ï¼š
   - æ”¹ç”¨ `TEST_USER_ID` å¸¸æ•¸è€Œéç¡¬ç·¨ç¢¼ "TEST_DEV_001"
   - ç¢ºä¿ä¸€è‡´æ€§å’Œæ˜“ç¶­è­·æ€§

**ä¿®å¾©æˆæœ**ï¼š
- âœ… æ¶ˆé™¤ "Cannot read properties of undefined (reading 'toUpperCase')" éŒ¯èª¤
- âœ… testMessage ç¾åœ¨èƒ½æ­£ç¢ºå»ºç«‹ LINE äº‹ä»¶ä¸¦å‚³éåƒæ•¸
- âœ… æ¸¬è©¦ä»‹é¢ç©©å®šå¯ç”¨

## v27.3.6 (2025-12-09) - å…¨ç«¯åŒæ­¥æ‰‹è¡“ (è§£æ±ºã€Œä¸€ç›´æ€è€ƒä¸­ã€å•é¡Œ)

**å•é¡Œè¨ºæ–·**ï¼š
- **ç—‡ç‹€**ï¼šå‰ç«¯ä¸€ç›´åœç•™åœ¨ã€Œæ€è€ƒä¸­ã€ï¼Œä½† LOG é¢æ¿æœ‰å³æ™‚é€²åº¦
- **æ ¹æœ¬åŸå› **ï¼šå¾Œç«¯ `testMessage` å›å‚³æ ¼å¼è·Ÿå‰ç«¯é æœŸä¸ç¬¦
  - å¾Œç«¯å¯èƒ½å›å‚³ Error ç‰©ä»¶æˆ–æ ¼å¼æ··äº‚çš„ Log é™£åˆ—
  - å‰ç«¯ç„¡æ³•æ­£ç¢ºè§£æï¼Œæ‰€ä»¥å¡åœ¨ `withSuccessHandler` ç­‰å¾…ç‹€æ…‹

**å¾Œç«¯ä¿®å¾© (linebot.gs - V27.3.6 çµ‚æ¥µç‰ˆ)**ï¼š
1. **å¼·åˆ¶çµ±ä¸€å›å‚³æ ¼å¼**ï¼š
   ```javascript
   return {
     success: true,
     reply: botResponse,      // ç›´æ¥çµ¦å‰ç«¯æœ€çµ‚å›è¦†æ–‡æœ¬
     logs: TEST_LOGS,         // å®Œæ•´ LOG é™£åˆ—
     tokens: tokenInfo        // Token çµ±è¨ˆ
   };
   ```

2. **æ””æˆª ContentService éŒ¯èª¤**ï¼š
   - `handleMessage()` å…§éƒ¨æœƒå‘¼å« `ContentService.createTextOutput()`
   - é€™å€‹ç‰©ä»¶åœ¨ç¶²é ç«¯ç„¡æ³•è®€å–ï¼Œæœƒå°è‡´å ±éŒ¯
   - V27.3.6 åœ¨ try-catch ä¸­åˆ¤æ–·ä¸¦å¿½ç•¥æ­¤é¡éè‡´å‘½éŒ¯èª¤

3. **æ™ºæ…§æå–å›è¦†**ï¼š
   - åå‘æœå°‹ TEST_LOGSï¼Œä¾å„ªå…ˆç´šæå–å›è¦†ï¼š
     - [AI Reply] > [Reply] > [API Short Response]
     - è‹¥æª¢æ¸¬åˆ°ã€Œåå•ã€ï¼Œè¿”å›ã€Œè«‹é¸æ“‡å‹è™Ÿã€æç¤º

**å‰ç«¯ä¿®å¾© (TestUI.html - v2.2)**ï¼š
1. **ç°¡åŒ– withSuccessHandler é‚è¼¯**ï¼š
   ```javascript
   .withSuccessHandler(function(res) {
     // res ç¾åœ¨æ˜¯æ¸…æ™°çš„ç‰©ä»¶ï¼š{ success, reply, logs, tokens }
     if (res && res.logs) updateLogs(res.logs);
     addMsg("bot", res.reply || "(ç„¡å›è¦†)");
   })
   ```

2. **ä¸å†è‡ªå·± parse Log**ï¼š
   - åˆªé™¤è¤‡é›œçš„ Log è¡Œè§£æé‚è¼¯
   - ç›´æ¥ä¿¡ä»»å¾Œç«¯çµ¦å‡ºçš„ `res.reply` æ–‡æœ¬

3. **UI æ”¹é€²**ï¼š
   - ç§»é™¤ Toast é€šçŸ¥ï¼ˆç°¡åŒ–)
   - æ”¹ç”¨ `TEST_USER_ID` å¸¸æ•¸ç¢ºä¿ä¸€è‡´æ€§
   - ä½‡åˆ—é¡¯ç¤ºæ›´æ¸…æ™°ï¼ˆã€Œæ’ç¨‹ã€è€Œéã€Œç­‰å¾…ç™¼é€ã€ï¼‰

**ä¿®å¾©æˆæœ**ï¼š
- âœ… å‰ç«¯ç«‹å³æ”¶åˆ° `{ success, reply, logs }` ç‰©ä»¶
- âœ… ä¸å†å¡åœ¨ã€Œæ€è€ƒä¸­ã€
- âœ… LOG å³æ™‚æ»¾å‹•ï¼Œå›è¦†ç«‹å³é¡¯ç¤º
- âœ… å…©ç«¯èªè¨€çµ±ä¸€ï¼Œé€šä¿¡ç©©å®š

## v27.3.7 (2025-12-09) - çµ‚æ¥µé˜²å‘†ç‰ˆï¼ˆæ ¹æ²» trim éŒ¯èª¤ï¼‰

**å•é¡Œè¨ºæ–·**ï¼š
- **ç—‡ç‹€ 1**ï¼šé»æ“Šã€Œ3ã€æˆ–å…¶ä»–å¿«æ·éµæ™‚ï¼Œå‡ºç¾ `Fatal Error: trim is not a function`
- **ç—‡ç‹€ 2**ï¼šv27.3.6 ä¿®å¾©ã€Œä¸€ç›´æ€è€ƒä¸­ã€å¾Œï¼Œæ•¸å­—å‹åˆ¥åƒæ•¸å°è‡´æ–°éŒ¯èª¤
- **æ ¹æœ¬åŸå› **ï¼š
  - å‰ç«¯å¯èƒ½å‚³å…¥æ•¸å­— `3` è€Œéå­—ä¸² `"3"`
  - å¾Œç«¯ `handleMessage` ä¸­çš„ `userMessage.trim()` åªèƒ½è™•ç†å­—ä¸²
  - JavaScript ä¸­ `Number.prototype` æ²’æœ‰ `trim()` æ–¹æ³•

**å¾Œç«¯ä¿®å¾© (linebot.gs - V27.3.7)**ï¼š
1. **å¼·åˆ¶è½‰å­—ä¸²é˜²å‘†**ï¼š
   ```javascript
   // ğŸ”¥ã€çµ•å°é˜²å‘†ã€‘å¼·åˆ¶è½‰å‹ç‚ºå­—ä¸²ï¼Œæ ¹æ²» "trim is not a function" éŒ¯èª¤
   if (msg === undefined || msg === null) msg = "";
   msg = String(msg); 
   ```
   - å…ˆæª¢æŸ¥ null/undefined
   - ç„¶å¾Œ**ç„¡æ¢ä»¶**ç”¨ `String()` è½‰å‹
   - ç¢ºä¿å‚³çµ¦ handleMessage çš„çµ•å°æ˜¯å­—ä¸²

2. **çµ±ä¸€è¨»è§£é¢¨æ ¼**ï¼š
   - ç”¨ `---` å€éš”ä¸»è¦é‚è¼¯å€å¡Š
   - ç”¨ `ğŸ”¥ã€ã€‘` æ¨™è¨˜é—œéµé˜²å‘†é»

3. **éŒ¯èª¤è¨Šæ¯å„ªåŒ–**ï¼š
   - `[Fatal] ç³»çµ±å´©æ½°` æ”¹ç‚ºæ›´æ˜ç¢ºçš„éŒ¯èª¤æç¤º
   - æç¤ºæª¢æŸ¥ linebot.gs è€Œéå‰ç«¯

**å‰ç«¯ä¿®å¾© (TestUI.html - v2.3)**ï¼š
1. **Toast é€šçŸ¥æ¢å¾©**ï¼š
   - `copyLogs()` æ”¹ç”¨ `showToast()` è€Œé `alert()`
   - `clearSession()` å¢åŠ  Toast æç¤º

2. **æ–‡æ¡ˆå¾®èª¿**ï¼š
   - "æ¨¡æ“¬å™¨å·²é€£ç·š" â†’ "æ¨¡æ“¬å™¨é€£ç·šæˆåŠŸ"

**ä¿®å¾©åŸç†èªªæ˜**ï¼š
- JavaScript çš„ `String()` æ˜¯å‹åˆ¥è½‰æ›å‡½æ•¸ï¼Œå¯è™•ç†ï¼š
  - æ•¸å­—ï¼š`String(3)` â†’ `"3"`
  - å¸ƒæ—ï¼š`String(true)` â†’ `"true"`
  - nullï¼š`String(null)` â†’ `"null"`ï¼ˆå…ˆæª¢æŸ¥é¿å…ï¼‰
  - undefinedï¼š`String(undefined)` â†’ `"undefined"`ï¼ˆå…ˆæª¢æŸ¥é¿å…ï¼‰
  - ç‰©ä»¶ï¼š`String({a:1})` â†’ `"[object Object]"`

**ä¿®å¾©æˆæœ**ï¼š
- âœ… ä»»ä½•è³‡æ–™å‹åˆ¥å‚³å…¥éƒ½æœƒè¢«è½‰æˆå­—ä¸²
- âœ… `trim()` æ°¸é ä¸æœƒå ±éŒ¯
- âœ… æ•¸å­—ã€å¸ƒæ—ã€ç‰©ä»¶éƒ½èƒ½æ­£å¸¸è™•ç†
- âœ… å›å‚³æ ¼å¼çµ•å°ä¸€è‡´ `{ success, reply, logs, tokens }`

**GAS å³æ™‚é€²åº¦é™åˆ¶èªªæ˜**ï¼š
- Google Apps Script æ¡ç”¨ã€Œè«‹æ±‚-ç­‰å¾…-å›æ‡‰ã€æ¨¡å¼
- ç„¡æ³•åƒ WebSocket ä¸€æ¨£é‚ŠåŸ·è¡Œé‚Šæ¨é€ LOG
- å‰ç«¯çœ‹åˆ°çš„ã€Œæ€è€ƒä¸­ã€æ˜¯æ­£å¸¸çš„ GAS è¡Œç‚º
- LOG æœƒåœ¨åŸ·è¡Œå®Œç•¢å¾Œä¸€æ¬¡å…¨éƒ¨é¡¯ç¤ºï¼ˆé€™æ˜¯ GAS æ¶æ§‹é™åˆ¶ï¼Œç„¡æ³•æ”¹è®Šï¼‰

## v27.3.8 (2025-12-09) - handleMessage æºé ­é˜²å½ˆï¼ˆé›™å±¤å¼·åˆ¶è½‰å‹ï¼‰

**å•é¡Œå›é¡§**ï¼š
- v27.3.7 åœ¨ testMessage åšäº†å¼·åˆ¶è½‰å‹ï¼Œä½† handleMessage æ²’æœ‰
- ç•¶ testMessage ç›´æ¥å‘¼å« handleMessage æ™‚ï¼Œåƒæ•¸å¯èƒ½å·²ç¶“éè™•ç†
- ä½† LINE webhook ç›´æ¥å‘¼å« handleMessage æ™‚ï¼Œevent.message.text å¯èƒ½æ˜¯æ•¸å­—
- å°è‡´ trim éŒ¯èª¤ä¾ç„¶å­˜åœ¨

**çµ‚æ¥µä¿®å¾©ï¼ˆhandleMessage æºé ­é˜²å½ˆï¼‰**ï¼š
```javascript
function handleMessage(userMessage, userId, replyToken, contextId, messageId) {
  try {
    // ğŸ”¥ å¼·åˆ¶è½‰å‹ï¼šä¸ç®¡å‚³ä¾†ä»€éº¼ï¼ˆæ•¸å­—ã€ç‰©ä»¶ã€nullï¼‰ï¼Œå…ˆè½‰æˆå­—ä¸²å†èªªï¼
    userMessage = String(userMessage || "");
    
    if (!userMessage || !userMessage.trim()) return;
    const msg = userMessage.trim();
```

**é›™å±¤é˜²è­·æ¶æ§‹**ï¼š
1. **testMessageï¼ˆæ¸¬è©¦å…¥å£ï¼‰**ï¼š`msg = String(msg);` - ä¿è­·æ¸¬è©¦ç’°å¢ƒ
2. **handleMessageï¼ˆä¸»ç¨‹å¼å…¥å£ï¼‰**ï¼š`userMessage = String(userMessage || "");` - **æºé ­é˜²è­·**

**ç‚ºä»€éº¼éœ€è¦å…©å±¤ï¼Ÿ**
- testMessage â†’ handleMessageï¼ˆæ¸¬è©¦è·¯å¾‘ï¼‰ï¼šç¬¬ä¸€å±¤å·²é˜²è­·
- LINE webhook â†’ handleMessageï¼ˆçœŸå¯¦è·¯å¾‘ï¼‰ï¼š**å¿…é ˆç¬¬äºŒå±¤é˜²è­·**
- ç¢ºä¿ä»»ä½•å…¥å£é€²å…¥éƒ½å®‰å…¨

**ä¿®å¾©æˆæœ**ï¼š
- âœ… çœŸå¯¦ LINE è¨Šæ¯ä¸æœƒ trim éŒ¯èª¤
- âœ… æ¸¬è©¦ä»‹é¢ä¸æœƒ trim éŒ¯èª¤
- âœ… ä»»ä½•è³‡æ–™å‹åˆ¥éƒ½èƒ½æ­£ç¢ºè™•ç†
- âœ… é›™å±¤ä¿éšªï¼Œè¬ç„¡ä¸€å¤±

## v27.3.9 (2025-12-09) - Cache é«’è³‡æ–™é˜²è­·ï¼ˆæ ¹æ²» null.length éŒ¯èª¤ï¼‰

**å•é¡Œæ ¹æº**ï¼š
- **ç—‡ç‹€**ï¼š`TypeError: Cannot read properties of null (reading 'length')`
- **åŸå› **ï¼šCache ä¸­å­˜å…¥äº† `null` æˆ–éé™£åˆ—è³‡æ–™
  - `JSON.parse('null')` æœƒè¿”å› `null` è€Œéé™£åˆ—
  - é«’è³‡æ–™ï¼šèˆŠç‰ˆæœ¬å¯èƒ½å­˜å…¥äº† `"null"` å­—ä¸²
  - å°è‡´ `cachedDirectModels.length` å¤±æ•—

**ä¿®å¾©ç­–ç•¥ï¼ˆä¸‰å±¤é˜²è­·ï¼‰**ï¼š

1. **handleMessage - Cache è§£æé˜²è­·**ï¼š
   ```javascript
   // v27.3.9: åŠ å¼·é˜²å‘† - é˜²æ­¢ Cache é«’è³‡æ–™ï¼ˆnull/éé™£åˆ—ï¼‰å°è‡´ length éŒ¯èª¤
   const cachedDirectModelsJson = cache.get(`${userId}:direct_search_models`);
   let cachedDirectModels = [];
   try {
       if (cachedDirectModelsJson) {
           const parsed = JSON.parse(cachedDirectModelsJson);
           // ğŸ”¥ çµ•å°é˜²å‘†ï¼šå¦‚æœ parse å‡ºä¾†æ˜¯ null æˆ–éé™£åˆ—ï¼Œå¼·åˆ¶è®Šæˆ []
           cachedDirectModels = Array.isArray(parsed) ? parsed : [];
       }
   } catch(e) {
       writeLog(`[Cache Parse Error] direct_search_models è½‰æ›å¤±æ•—: ${e.message}`);
   }
   const hasSelectedPdf = cachedDirectModels.length > 0;  // ç¾åœ¨çµ•å°å®‰å…¨
   ```

2. **testMessage - è¼¸å…¥æ¸…æ´—å¼·åŒ–**ï¼š
   ```javascript
   // ğŸ”¥ã€çµ‚æ¥µé˜²å‘†ã€‘å¼·åˆ¶æ¸…æ´—è¼¸å…¥è³‡æ–™ï¼šè™•ç†ç‰©ä»¶ã€nullã€undefinedã€æ•¸å­—ç­‰æ‰€æœ‰ç•°å¸¸æƒ…æ³
   if (typeof msg === 'object') {
       try { msg = JSON.stringify(msg); } catch(e) { msg = ""; }
   }
   msg = String(msg || "").trim();
   if (msg === "") msg = "æ¸¬è©¦ç©ºè¨Šæ¯";  // é¿å…ç©ºè¨Šæ¯èª¤åˆ¤
   ```

3. **clearTestSession - æ·±å±¤æ¸…æ½”**ï¼š
   ```javascript
   // ğŸ”¥ v27.3.9: é¡å¤–æ¸…é™¤å¯èƒ½çš„é«’è³‡æ–™
   cache.remove(`HISTORY_${userId}`);
   cache.remove(`PENDING_PDF_${userId}`);
   ```

**ç‚ºä»€éº¼éœ€è¦ Array.isArray()ï¼Ÿ**
- `JSON.parse('null')` â†’ `null` âŒ
- `JSON.parse('[]')` â†’ `[]` âœ…
- `JSON.parse('[1,2,3]')` â†’ `[1,2,3]` âœ…
- `JSON.parse('"test"')` â†’ `"test"` âŒï¼ˆå­—ä¸²ä¸æ˜¯é™£åˆ—ï¼‰
- `Array.isArray(null)` â†’ `false` â†’ å¼·åˆ¶è®Š `[]` âœ…

**ä¿®å¾©æˆæœ**ï¼š
- âœ… Cache è®€å–æ°¸é è¿”å›æœ‰æ•ˆé™£åˆ—ï¼ˆå³ä½¿å­˜å…¥çš„æ˜¯ nullï¼‰
- âœ… `cachedDirectModels.length` æ°¸é ä¸æœƒå ±éŒ¯
- âœ… æ·±å±¤æ¸…æ½”æ©Ÿåˆ¶æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„é«’å¿«å–
- âœ… ç‰©ä»¶è¼¸å…¥è‡ªå‹•è½‰ JSON å­—ä¸²ï¼Œä¸æœƒç‚¸æ‰

**ç”¨æˆ¶æ“ä½œå»ºè­°**ï¼š
æ¸¬è©¦ä»‹é¢é»æ“Š **âš¡ï¸ é‡ç½®** æŒ‰éˆ•ï¼ŒåŸ·è¡Œæ·±å±¤æ¸…æ½”ï¼Œæ¸…é™¤æ‰€æœ‰èˆŠçš„é«’å¿«å–ã€‚

## v27.4.1 (2025-12-09) - æœ€çµ‚ä¿®æ­£ï¼šæºé ­æ·¨åŒ–

### æ ¹æœ¬å•é¡Œç™¼ç¾

ç¶“é v27.3.9ã€v27.4.0 å¤šæ¬¡ä¿®å¾©å¾Œï¼Œç™¼ç¾ **çœŸæ­£çš„æºé ­å•é¡Œ**ï¼š

1. **v27.4.0 çš„éåº¦è½‰å‹é™·é˜±**ï¼š
   - ä½¿ç”¨ `JSON.stringify(msg)` å°‡ç‰©ä»¶è½‰æˆå­—ä¸²ï¼Œçµæœè®Šæˆ `"[object Object]"`
   - å†ç”¨ `String()` åŒ…è£¹ï¼Œå°è‡´é€™å€‹é«’å­—ä¸²é€²å…¥ `handleMessage`
   - å¾ŒçºŒæ‰€æœ‰é‚è¼¯ï¼ˆå‹è™Ÿæå–ã€æ­·å²æŸ¥è©¢ï¼‰éƒ½æœƒå¤±æ•—ï¼Œæœ€çµ‚å ± `null.length` éŒ¯èª¤

2. **å•é¡Œä¸åœ¨é˜²ç¦¦ï¼Œè€Œåœ¨è½‰å‹é‚è¼¯æœ¬èº«**

### v27.4.1 ä¿®å¾©ç­–ç•¥

**ä¸‰é …æ”¹è®Š**ï¼š

#### 1ï¸âƒ£ handleMessage - æºé ­æ·¨åŒ–
```javascript
// OLD (v27.4.0)ï¼šéåº¦è½‰å‹ï¼Œå®¹æ˜“æ±¡æŸ“
const userMessage = String(event.message.text || "").trim();

// NEW (v27.4.1)ï¼šç›´æ¥æª¢æŸ¥é¡å‹ï¼Œçµ•ä¸éåº¦è½‰å‹
let userMessage = event.message.text;
if (typeof userMessage !== 'string') {
    userMessage = "";
}
userMessage = userMessage.trim();

// é¡å¤–é˜²ç·šï¼šè‹¥çœŸçš„æ”¶åˆ°é«’å­—ä¸²ï¼Œå¼·åˆ¶ä¿®æ­£
if (userMessage === "[object Object]") {
    userMessage = "æ¸¬è©¦";
    writeLog(userId, "Warning", "åµæ¸¬åˆ° [object Object] é«’è¼¸å…¥ï¼Œå·²è‡ªå‹•ä¿®æ­£");
}
```

**ä¿®å¾©æ•ˆæœ**ï¼š
- âœ… ä¸å†éåº¦è½‰å‹ï¼Œé¿å… `[object Object]` å­—ä¸²æ±¡æŸ“
- âœ… è‹¥çœŸçš„æ”¶åˆ°é«’å­—ä¸²ï¼Œæœ‰æœ€å¾Œä¸€é“é˜²ç·š
- âœ… è¨Šæ¯ä¿æŒç´”æ·¨ï¼Œå¾ŒçºŒé‚è¼¯ä¸æœƒå´©æ½°

#### 2ï¸âƒ£ testMessage - ç§»é™¤ JSON.stringify
```javascript
// OLD (v27.4.0)ï¼šæœƒæŠŠç‰©ä»¶è®Šæˆ "[object Object]" å­—ä¸²
if (typeof msg === 'object') {
    try { msg = JSON.stringify(msg); } catch(e) { msg = ""; }
}

// NEW (v27.4.1)ï¼šç°¡å–®ç²—æš´ï¼Œçµ•å°æœ‰æ•ˆ
if (msg === undefined || msg === null) {
    msg = "";
} else if (typeof msg !== 'string') {
    msg = String(msg); // å¼·åˆ¶è½‰å­—ä¸²
}

// å†æ¬¡æª¢æŸ¥ï¼Œå¦‚æœæ˜¯é«’å­—ä¸²ï¼Œå¼·åˆ¶æ¸…ç©º
if (msg === "[object Object]") msg = "";
```

**ä¿®å¾©æ•ˆæœ**ï¼š
- âœ… æ°¸é ä¸ç”¨ `JSON.stringify`
- âœ… äºŒæ¬¡æª¢æŸ¥ï¼Œç¢ºä¿è¼¸å…¥çµ•å°ä¹¾æ·¨
- âœ… å‰ç«¯å‚³éä¾†çš„ä»€éº¼æ±è¥¿éƒ½èƒ½å®‰å…¨æ¶ˆæ¯’

#### 3ï¸âƒ£ clearTestSession - ä¿æŒç°¡å–®
```javascript
// å›åˆ°æœ€ç°¡å–®çš„é‚è¼¯ï¼Œå°±æ¸…é€™ 4 å€‹æ ¸å¿ƒ Key
cache.remove(`${userId}:context`);
cache.remove(`${userId}:pdf_mode`);
cache.remove(`${userId}:direct_search_models`);
cache.remove(`${userId}:hit_alias_key`);
```

### ç‚ºä»€éº¼é€™æ¬¡ä¸€å®šæœƒéï¼Ÿ

**v27.4.0 vs v27.4.1 çš„æ ¹æœ¬å·®ç•°**ï¼š

| ç‰ˆæœ¬ | ç­–ç•¥ | å•é¡Œ |
|------|------|------|
| v27.3.9 | Array.isArray() æª¢æŸ¥ | åªèƒ½è£œæ•‘å·²ç¶“é€²ä¾†çš„é«’è³‡æ–™ |
| v27.4.0 | æš´åŠ›è½‰å‹é˜²ç¦¦ | ç”¨ JSON.stringify åè€Œè£½é€ é«’è³‡æ–™ï¼ |
| v27.4.1 | æºé ­æ·¨åŒ–ï¼Œä¸è½‰å‹ | **å¾æ ¹æœ¬é˜²æ­¢æ±¡æŸ“** âœ¨ |

**é—œéµå€åˆ¥**ï¼š
- âŒ v27.4.0ï¼šå˜—è©¦æŠŠæ‰€æœ‰æ±è¥¿éƒ½è½‰æˆå­—ä¸²ï¼ˆåŒ…æ‹¬ç‰©ä»¶ï¼‰â†’ è£½é€  `[object Object]`
- âœ… v27.4.1ï¼šåªæ¥å—å­—ä¸²ï¼Œéå­—ä¸²å°±è¨­ç‚ºç©º â†’ æ°¸é ç´”æ·¨

### æ“ä½œæŒ‡å—

1. **åˆ·æ–°æ¸¬è©¦ç¶²é **ï¼ˆF5ï¼‰
2. **ç«‹åˆ»é»æ“Šã€Œâš¡ï¸ é‡ç½®ã€æŒ‰éˆ•** â†’ æ¸…é™¤èˆŠç‰ˆæœ¬çš„é«’ Cache
3. **é–‹å§‹æ¸¬è©¦**ï¼š
   - é»ã€Œ1ã€ã€ã€Œ2ã€ã€ã€Œ3ã€ç­‰å„ç¨®è¼¸å…¥
   - è©¢å• M9ã€M8 çš„å‹è™Ÿç›¸é—œå•é¡Œ
   - æª¢æŸ¥æ²’æœ‰ `trim is not a function` æˆ– `.length` éŒ¯èª¤

### é æœŸçµæœ

âœ… æ²’æœ‰ä»»ä½•éŒ¯èª¤æ—¥èªŒ  
âœ… AI æ­£å¸¸å›æ‡‰  
âœ… å‹è™Ÿè¨˜æ†¶å’Œè¡çªæª¢æŸ¥æ­£å¸¸å·¥ä½œ  
âœ… PDF æ·±åº¦æœå°‹æŒ‰é æœŸè§¸ç™¼  

---

## æ¥ä¸‹ä¾†çš„ç¶­è­·

1. **ç›£æ§ emoji å•é¡Œ**ï¼šè‹¥å†æ¬¡å‡ºç¾ï¼Œæª¢æŸ¥ Prompt.csv æ˜¯å¦æœ‰æ–°çŸ›ç›¾è¦å‰‡
2. **Token æˆæœ¬é ç®—**ï¼šDeep Mode æ­£å¸¸æ‡‰åœ¨ 100-150k tokensï¼ˆå« PDFï¼‰
3. **PDF è¼‰å…¥é‚è¼¯**ï¼šå‹è™Ÿæ“´å……æ‡‰å— `hasInjectedModels` é™åˆ¶
4. **ç‰ˆæœ¬æ›´æ–°æµç¨‹**ï¼šlinebot.gsã€Prompt.csvã€MD æ–‡ä»¶æ‡‰åŒæ­¥æ›´æ–°ç‰ˆæœ¬è™Ÿ

## æ¸¬è©¦ä»‹é¢æ¸…é™¤æŒ‡å—

ç•¶æ¸¬è©¦å®Œæˆã€ç§»é™¤ TestUI æ™‚ï¼š
1. åˆªé™¤ TEST MODE GLOBALS å€å¡Šï¼ˆlines 1-9ï¼‰
2. åˆªé™¤ writeLogã€writeRecordDirectlyã€replyMessage ä¸­çš„ IS_TEST_MODE æª¢æŸ¥
3. åˆªé™¤ doGetã€testMessageã€clearTestSession å‡½æ•¸ï¼ˆå€å¡Š 9ï¼‰
4. åˆªé™¤ TestUI.html æª”æ¡ˆ
5. `clasp push -f` éƒ¨ç½²
6. ç‰ˆæœ¬è™Ÿæ”¹ç‚º v28.0.0

---
**ä¸Šæ¬¡æ›´æ–°**ï¼š2025-12-09  
**ä¸‹ä¸€ç›®æ¨™ç‰ˆæœ¬**ï¼šv28.0.0ï¼ˆå¯è€ƒæ…®çš„æ–¹å‘ï¼šè¯ç¹« Sam æç¤ºå„ªåŒ–ã€æ¨¡å‹é·ç§»å‡ç´šã€å¤šèªè¨€æ”¯æ´ï¼‰
