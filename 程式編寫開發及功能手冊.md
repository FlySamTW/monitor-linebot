# Samsung LINE Bot 完整流程解析 (v29.5.48)

## 📋 核心哲學

AI 優先 (AI-First) + 程式輔助 (Code-Assisted)

- AI 判斷能回答 → 直接回答
- AI 判斷資料不足 → 輸出暗號 → 程式接手執行

---

## 🔄 完整流程圖

```mermaid
graph TD
    User[用戶發送訊息] --> API[1. 訊息入口 (doPost)]
    API --> Handle[2. 訊息分流 (handleMessage)]

    Handle -- 指令/建檔 --> Cmd[指令/建檔模式]
    Handle -- 一般對話 --> DirectCheck[3. 直通車偵測]

    DirectCheck -- 命中 CLASS_RULES --> CacheKey[注入型號至 Cache]
    DirectCheck --> FastMode[4. 極速模式]
    CacheKey --> FastMode

    subgraph Core[核心回答邏輯]
        FastMode -- 載入 QA + RULES --> LLM1[呼叫 LLM (無 PDF)]
        LLM1 --> Decision{AI 能回答?}

        Decision -- YES --> Reply[直接回覆]
        Decision -- NO --> SignalCheck{輸出暗號?}

        SignalCheck -- AUTO_SEARCH_PDF --> PDFMode[5. PDF 模式]
        SignalCheck -- AUTO_SEARCH_WEB --> WebMode[6. 網路搜尋]

        subgraph PDFFlow[PDF 智慧流程]
            PDFMode --> PDFLoad[載入 PDF (Max 1-2本)]
            PDFLoad --> LLM2[LLM 重試]
            LLM2 --> Reply
        end

        subgraph WebFlow[Web 搜尋流程]
            WebMode --> GoogleSearch[啟用 Google Search]
            GoogleSearch --> LLM3[LLM 重試]
            LLM3 --> Reply
        end
    end
```

---

## 📚 知識來源優先級 (鐵律)

1. 🥇 **最高優先: QA 資料庫 (QA.csv)**
   - 精選問答，高命中率常見問題
2. 🥈 **第二優先: CLASS_RULES (規格庫)**
   - 型號規格 + 術語定義
   - 自動生成 KEYWORD_MAP 供擴充
3. 🥉 **第三優先: PDF 手冊 (三星螢幕使用手冊/)**
   - 詳細操作步驟、OSD 路徑、故障排除
   - 觸發條件: `[AUTO_SEARCH_PDF]` 或直通車強制
4. 🏆 **最後手段: 網路搜尋 (Google Search)**
   - 完全無解時的備援
   - 觸發條件: `[AUTO_SEARCH_WEB]` 或用戶強制 /擴大搜尋

---

## 🔑 關鍵暗號系統

| 暗號                | 觸發時機              | 系統行為                          |
| ------------------- | --------------------- | --------------------------------- |
| `[AUTO_SEARCH_PDF]` | QA/規格不足，需查手冊 | 載入對應 PDF，重新呼叫 LLM        |
| `[AUTO_SEARCH_WEB]` | PDF 也沒答案，需聯網  | 啟用 Google Search 工具，呼叫 LLM |
| `[NEW_TOPIC]`       | AI 判斷換題           | 清除 PDF Mode，重置上下文         |
| `[型號:xxx,yyy]`    | AI 建議多型號         | 自動生成 Quick Reply 選單         |

---

## 🎯 型號匹配邏輯 (Smart Router v29.5.48)

用戶輸入: "S27AG500NC 怎麼設定"

1. **直通車偵測**: 命中 "G5" (別稱)
   - 系統注入: G5, S27FG532EC, S27DG502EC...

2. **Smart Router 判斷 (v29.5.48 New)**:
   - **單一型號**: 自動鎖定，載入 1 本 PDF。
   - **多型號 (比較/列表題)**:
     - 若用戶問「哪一台...」、「推薦...」 (List Intent) → **跳過泡泡**，讓 AI 直接列出。
     - 若僅是模糊查詢 → 顯示 **型號選擇泡泡**。
   - **數量過多**: 若候選 > 10 個 → 跳過泡泡，避免洗版。

3. **精準匹配**:
   - 找到 `S27AG500NC.pdf`
   - 載入 PDF → LLM 回答設定步驟

---

## 🛡️ 安全防護機制

1. **源頭減量**
   - 非比較題: 強制 1 本 PDF
   - 比較題: 最多 2 本 PDF
2. **重試策略 (callLLMWithRetry)**
   - Retry 1: 移除第 2 本 PDF
   - Retry 2: 移除所有 PDF (終極降級)
   - Retry 3: 放棄，回傳錯誤訊息
3. **Token 熔斷**
   - 預估 > 40K tokens
   - 裁切歷史，保留最新 2 對對話
4. **事件去重**
   - 相同 eventId 60 秒內不重複處理

---

## 📊 資料流動示意

```
Google Sheet ──────► Cache ──────► GAS
   │                   │            │
   ├─ QA              │            ├─ buildDynamicContext()
   ├─ CLASS_RULES     │            ├─ getRelevantKBFiles()
   └─ Prompt          │            ├─ callLLMWithRetry()
                       │            └─ replyMessage()
                       │
Google Drive ──────► Gemini File API
   │                               │
   └─ PDF 手冊 ───────────────────┘
```

---

## 📜 版本更新紀錄

### v29.5.52 (2026-01-19 13:15)

- **Feat (UX)**: 優化 Quick Reply (擴大搜尋) 引導按鈕。
  - **情境感知**:
    - **Fast Mode (規格)**: 按鈕文字「不滿意 (查手冊)」，預告需虛耗 30 秒。
    - **PDF Mode**: 按鈕文字「不滿意 (搜網路)」，引導至外部搜尋。
    - **Web Mode**: 按鈕文字「不滿意 (繼續搜)」，嘗試更多網路來源。

### v29.5.51 (2026-01-19 13:10)

- **Fix (Logic)**: PDF 載入邏輯重大修正。
  - **Revert**: 撤銷 v29.5.49 的別名阻擋邏輯，確保 `G5` 別名能被擴展，避免因 PDF 檔名僅含別名而找不到檔案。
  - **New**: 新增「智慧權重排序 (Smart Prioritization)」，在 Tier 1 內若同時找到多個 PDF，優先選用包含「完整型號 (S27AG500NC)」的檔案，其次為「S開頭型號」，最後才選「別名 (G5)」。
- **Fix (UX)**: 修正 Web 搜尋失敗導致的回應空白問題（透過確保 PDF 載入成功來根治）。

### v29.5.50 (2026-01-19 13:05)

- **Feat (UX)**: 新增「動態泡泡 (Dynamic Bubble)」功能。
  - 根據用戶問句意圖（規格/手冊/價格），自動調整 Smart Router 泡泡的標題與說明文字。
  - 例如問「價格」，泡泡會顯示「查詢價格/通路」；問「設定」，顯示「查閱產品手冊」。

### v29.5.49 (2026-01-19 12:55)

- **Fix (Critical)**: 修復 `getRelevantKBFiles` 中 `primaryModel` 變數在初始化前被呼叫導致的 `ReferenceError` 崩潰問題。
- **Fix (UX)**: 修正型號選擇泡泡按鈕回傳值。由原本的「[型號] 怎麼設定」改為僅回傳「[型號]」，讓 AI 能正確銜接上下文回答用戶的原問題（如「寬度」），而非強制回答設定步驟。
- **Fix (Logic)**: 優化別名擴展邏輯。當用戶已指定明確型號（如 S27AG500NC）時，不再擴展寬泛別名（如 G5），避免載入錯誤的 PDF。

### v29.5.48 (2026-01-19 11:45)

- **Fix (UX)**: 針對通用問題（如「哪一台...」、「推薦...」或候選數 > 10），跳過 Smart Router 泡泡，讓 AI 直接列出清單。
