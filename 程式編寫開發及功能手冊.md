# LINE Bot Assistant - 台灣三星電腦螢幕專屬客服

## 📋 專案資訊

| 項目 | 說明 |
|------|------|
| **版本** | v27.3.6 (全端同步手術 - 修復「一直思考中」問題) |
| **平台** | Google Apps Script (GAS) |
| **AI 引擎** | Gemini 2.5 Flash |
| **通訊介面** | LINE Messaging API |
| **開發者** | Sam（同時為群組真人客服） |
| **核心機制** | `[AUTO_SEARCH_PDF]` 自動召喚 + PDF 智慧匹配 |

---

## 🆕 v24.5.x 修復紀錄

### v24.5.2 (2025-12-07) - 修復 PDF 反問時對話記憶丟失

**問題**：
用戶問「M8有附視訊鏡頭嗎」→ 觸發反問 → 用戶回覆「跟版本沒關係吧」→ AI 完全不記得之前的對話

**根本原因**：
當發送 PDF 型號選擇反問時，只做了 `writeRecordDirectly()`（記錄用），沒有呼叫 `updateHistorySheetAndCache()`，導致對話歷史沒有被更新。

**修復**：
```javascript
// v24.5.2: 修復對話記憶丟失問題
writeRecordDirectly(userId, msg, contextId, 'user', '');
writeRecordDirectly(userId, askMsg, contextId, 'assistant', '');

// 關鍵修復！更新對話歷史
const askMsgObj = { role: 'assistant', content: askMsg };
updateHistorySheetAndCache(contextId, history, userMsgObj, askMsgObj);
```

### v24.5.1 (2025-12-07) - CLASS_RULES 永遠注入

**問題**：
用戶問「M8有附視訊鏡頭嗎」→ CLASS_RULES 明明有寫「附磁吸視訊鏡頭」→ 但 AI 還是輸出 `[AUTO_SEARCH_PDF]` 要查 PDF

**根本原因**：
`buildDynamicContext()` 的邏輯是「QA 先搜，搜滿 15 筆就停」，導致 CLASS_RULES 被跳過。

**修復**：
CLASS_RULES 現在**獨立搜尋**，不受 QA 匹配數量限制：
```javascript
// v24.5.1: CLASS_RULES 永遠優先搜尋，不再受 QA 匹配數量限制
if (fullRules && allKeywords.length > 0) {
    // 獨立搜尋 Rules，上限 10 筆
}
```

---

## 🆕 v24.4 新功能：PDF 智慧匹配 + 型號反問

### 問題背景

用戶問「M8 的視訊鏡頭該如何使用」時：
- 直通車提取內部代號 `M80D`
- 但 PDF 檔名是 `S32BM801.pdf`、`S32FM803.pdf`、`S32DM803.pdf`
- `M80D` 無法匹配任何 PDF → 載入錯誤的手冊

### 解決方案

#### 1. CLASS_RULES 定義型號模式

```csv
別稱_M8,Smart Monitor M8，高階智慧螢幕，附磁吸視訊鏡頭...型號模式為：M80D或S32?M80*
```

#### 2. 新函數 `searchPdfByAliasPattern()`

從「型號模式為：XXX」提取模式，轉為正則匹配 PDF：
- `?` → `.` (任意單字元)
- `*` → `.*` (任意多字元)

#### 3. 完整流程

```
用戶：「M8 視訊鏡頭怎麼用」
  ↓
直通車命中 M8 → 記錄關鍵字（不立即開 PDF Mode）
  ↓
Fast Mode（QA + CLASS_RULES）
  ↓
AI 判斷資料不足 → 輸出 [AUTO_SEARCH_PDF]
  ↓
searchPdfByAliasPattern("M8") → 找到 3 個匹配
  ↓
反問：「M8 有幾個版本，請問型號開頭是？
  1️⃣ S32BM8...
  2️⃣ S32DM8...
  3️⃣ S32FM8...」
  ↓
用戶回覆「2」
  ↓
載入 S32DM803.pdf → 用原始問題重新回答
```

### 新增函數

| 函數 | 用途 |
|------|------|
| `searchPdfByAliasPattern()` | 從 CLASS_RULES 提取模式並搜尋 PDF |
| `handlePdfSelectionReply()` | 處理用戶的型號選擇回覆 |
| `buildPdfSelectionMessage()` | 生成反問訊息 |
| `checkDirectDeepSearchWithKey()` | 直通車檢查並返回命中關鍵字 |

### 新增 Cache Key

```javascript
PENDING_PDF_SELECTION: 'pending_pdf_sel_'  // 等待用戶選擇 PDF 型號
```

---

## 🧪 QA 測試結果

### 使用 CLASS_RULES 模擬 10 個問題

| # | 問題 | 邏輯狀態 | 備註 |
|----|------|--------|------|
| 1 | OLED 面板的優點是什麼？ | ⚠️ 需驗證 | 術語提取可能不完整 |
| 2 | S27FG706 可以 4K 嗎？ | ✅ 正常 | 型號查詢標準邏輯 |
| 3 | M9 是 OLED 嗎？ | ✅ 正常 | v24.1.8 M 系列修復確認 |
| 4 | G5 和 G7 的差別？ | ⚠️ 需驗證 | 多型號對比邏輯未驗證 |
| 5 | 有沒有曲面 240Hz 的？ | ⚠️ 需改進 | 關鍵字「240Hz」無法精確匹配 |
| 6 | Odyssey Hub 開啟遊戲沒有 3D 效果 | ✅ 正常 | 直通車邏輯確認工作 |
| 7 | S32FM703UC 支援 USB-C 充電嗎？ | ✅ 正常 | 標準型號規格查詢 |
| 8 | ViewFinity 和 Odyssey 的區別？ | ✅ 正常 | 系列術語查詢 |
| 9 | S49DG952SC 有智慧功能嗎？ | ✅ 正常 | 型號規格查詢 |
| 10 | Odyssey Hub → M7 型號變化 | ✅ 正常 | **v24.1.8 型號變化偵測確認** |

### 發現的潛在漏洞

#### 漏洞 A：術語提取不完整 (v24.1.8 後續改進)
```
問題：「OLED 面板的優點？」
原因：extractModelNumbers() 的正則未包括通用術語 (OLED, ViewFinity, etc)
影響：問題 1、5 可能無法精確提取關鍵字
狀態：建議未來版本改進
```

#### 漏洞 B：多型號對比邏輯
```
問題：「G5 和 G7 的差別？」
原因：buildDynamicContext() 無最佳化多型號對比邏輯
影響：系統可能只列舉而不進行對比分析
狀態：建議後續版本改進
```

#### 漏洞 C：複合關鍵字匹配失效
```
問題：「有沒有曲面 240Hz 的？」
原因：提取「240」「HZ」而非「240HZ」，無法精確匹配 CLASS_RULES
影響：問題 5 可能無法精確查詢
狀態：建議後續版本改進
```

### 結論

✅ **v24.1.8 核心功能確認**：
- 型號提取 (包括 M5-M9、S27-S57 等) 正常
- 型號變化偵測正常工作
- PDF Mode 清除邏輯確認有效
- 直通車關鍵字識別正常

⚠️ **待改進的地方**：
- 術語範圍需擴展（OLED、DisplayHDR、HAS 等）
- 複合關鍵字 (「240Hz」) 匹配邏輯
- 多型號對比回答邏輯

---

## 🔧 **v24.1.10 重大修復 - 直通車 PDF + 重啟記憶清除**

### **問題 1：Odyssey Hub 無法載入 PDF**
**症狀：** 即使命中「Odyssey Hub」直通車，系統仍無法載入相關 PDF（Files: 0/56）

**根本原因：**
- ✅ `checkDirectDeepSearch()` 成功命中直通車關鍵字
- ❌ 但無法從 KEYWORD_MAP 提取型號並注入 Cache
- ❌ `getRelevantKBFiles()` 收不到型號，無法匹配 PDF

**修復方案（v24.1.9 升級 → v24.1.10）：**

| 步驟 | 改進 |
|-----|------|
| 1 | 在 `checkDirectDeepSearch()` 中添加詳細日誌，顯示型號提取過程 |
| 2 | 調試發現：正則無法提取括號內的型號 (如 `(G90XF)`) |
| 3 | 增強：無論提取成功或失敗都記錄日誌，便於診斷 |
| 4 | Cache 通道機制驗證成功：型號現在能正確注入 `direct_search_models` |

**日誌變化：**
```
修復前：
[DirectDeep] 命中 CLASS_RULES 直通車關鍵字
[KB Select] Tier0: 0, Tier1: 0 (No Match: none), Total: 0  ❌

修復後：
[DirectDeep] 命中 ODYSSEYHUB
[DirectDeep] 查詢 KEYWORD_MAP[OdysseyHub] = Odyssey 3D (G90XF)...
[DirectDeep] 從映射值提取型號: G90XF
[DirectDeep] ✅ 注入型號到 Cache: G90XF
[KB Select] 讀取直通車注入型號: G90XF
[KB Select] 🎯 命中型號: G90XF → 載入 PDF  ✅
```

---

### **問題 2：重啟沒有清除對話記憶**
**症狀：** 執行 `/重啟` 後，系統顯示「對話已重置」，但 AI 仍然記得之前的對話

**根本原因：** Sheet 清除邏輯被註解（已被遺忘的歷史代碼）
```javascript
// 只清除了 Cache
cache.remove(`${CACHE_KEYS.HISTORY_PREFIX}${cid}`);

// ❌ 但沒有清除 Sheet
// s.getRange(f.getRow(), 2).clearContent();  // ← 被註解
```

當 Cache 失效後，系統自動降級讀取 Sheet 中的舊對話，導致記憶未清除。

**修復方案（v24.1.10 新增）：**

完全清除對話記憶的三個層級：
```javascript
1. 清除 Sheet 中的歷史記錄  ← 恢復被註解的邏輯
2. 清除 Cache 中的歷史記錄
3. 清除 PDF Mode 狀態
```

**日誌變化：**
```
修復前：
[Command] /重啟 by U...
[Command] 重啟完成:...
(下次訊息時) [PDF Mode] 延續 PDF 模式  ← ❌ 記憶沒清

修復後：
[Command] /重啟 by U...
[ClearHistory] 已從 Sheet 清除 contextId 的歷史記錄
[ClearHistory] ✅ 完全清除了 contextId 的對話記憶
[Command] 重啟完成:...
(下次訊息時) [PDF Mode] 無 (全新對話)  ✅
```

---

### **問題 3：QA 預覽無用日誌**
**症狀：** 日誌顯示「QA 內容預覽 (前 100 字)」，浪費空間且無實際用途

**修復：** 完全移除無用日誌
```javascript
// 移除這行
writeLog(`[Sync] QA 內容預覽 (前 100 字): ${qaContent.substring(0, 100)...`);
```

---

## 🔄 版本更新日誌

### v24.1.8 (2025-12-05) - 型號提取正則修正
- **問題**：「m7是什麼面板」仍不知道答案，即使 v24.1.7 已補全 M7 規格
- **根本原因**：`extractModelNumbers()` 的 M 系列正則有 bug
  ```javascript
  // 原始：/\bM([5789][\dA-Z]*)\b/g
  // 提取 "m7" 時：match[1] = "7" 而非 "M7" ❌
  ```
- **修復**：改為完整保留型號
  ```javascript
  // 修正：/\bM[5789][\dA-Z]*\b/g
  // 提取 "m7" 時：model = "M7" ✓
  ```
- **效果**：型號變化偵測能正常工作，系統清除 PDF Mode 用 CLASS_RULES 回答

### v24.1.7 (2025-12-05) - 動畫計時器重置 + M7 規格補全
- **問題 1**：重啟後第一次詢問沒有 Loading 動畫
  - 根本原因：`markAnimationShown()` 的 20 秒 TTL 未被清除
  - 修復：在 `/重啟` 命令後清除 `anim_${userId}` 的 Cache
- **問題 2**：「m7 是什麼面板」回答「資料沒寫」
  - 根本原因：CLASS_RULES 中 M7 定義缺少面板類型信息
  - 修復：更新 `別稱_M7` 加入「VA 平面面板」

### v24.1.6 (2025-12-05) - Odyssey Hub 關鍵字匹配修復
- **問題**：用戶說「Odyssey Hub」但 PDF 未能正確載入（Files: 0 / 56）
- **根本原因**：getRelevantKBFiles 的關鍵字匹配沒有去空白處理
- **修復**：
  - 新增「去空白」邏輯，同時檢查「Odyssey Hub」和「OdysseyHub」
  - 新增 `getPdfProductName()` 函數將 PDF 檔名轉換為用戶友善的產品名稱
  - 回覆文本改為「Odyssey 3D 產品手冊」而非檔名
- **影響**：第一問題現在能正確載入相關 PDF

### v24.1.5 (2025-12-05) - PDF Mode 黏性修復
- **問題**：用戶從 Odyssey 3D (G90XF) 切換到 M7 時，系統仍延續 PDF Mode，導致載入不相關 PDF
- **修復**：新增型號變化偵測，自動清除不相關的 PDF Mode
- **函數新增**：
  - `checkAndClearPdfModeOnModelChange()` - 偵測型號變化
  - `extractModelNumbers()` - 提取訊息中的型號編碼
- **邏輯改進**：优先使用 Fast Mode (QA/CLASS_RULES)，避免浪費 Token 在不相關 PDF

### v24.1.4 (2025-12-05) - 編輯 API 成本追蹤完善
- **Polish API**（初版生成）：加入 Token 和成本記錄
- **Refine API**（修改調整）：加入 Token 和成本記錄
- **Merge API**（多 QA 合併）：加入 Token 和成本記錄
- 建檔系統現在可完整追蹤每個步驟的 API 消耗
- 便於分析編輯操作的成本占比（預期 15-25% 取決於編輯複雜度）

### v24.1.3 (2025-12-05) - 編輯模式 THINK 最佳化
- **Polish API**（初版生成）：開啟 `thinkingBudget: 1024`
- **Refine API**（修改調整）：開啟 `thinkingBudget: 1024`  
- **Merge API**（多 QA 合併）：開啟 `thinkingBudget: 512`
- 保留邏輯任務關閉 THINK（Modify、FindSimilar）
- 預期成本增加 8-12%，但編輯品質大幅提升

### v24.1.2 (2025-12-05) - API 400 修復
- 根本原因：`thinkingConfig` 參數位置錯誤
- 修復方案：將 `thinkingConfig` 移至 `generationConfig` 內部
- 恢復 Think Mode 功能：PDF Mode 開啟 2048，Fast Mode 設為 0

### v24.1.1 - Token 用量測試模式
- 在回覆末尾顯示 In/Out/Total + NT$ 成本
- 匯率更新為 32

### v24.1.0 - Token 優化 + PDF 深度搜尋
- QA/Rules 智慧搜尋（上限 15 筆）
- Prompt.csv 精簡（65 → 48 行）
- Think Mode 條件開啟（PDF Mode 2048，Fast Mode 0）

---

## 🏗️ 系統架構 (Brain-First)

```
┌─────────────────────────────────────────────────────────────┐
│                     LINE Platform                            │
│                    (Webhook 入口)                            │
└──────────────────────┬──────────────────────────────────────┘
                       │ doPost()
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                  Google Apps Script                          │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           1. BRAIN LAYER (AI 大腦層) ⭐              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌────────────────┐ │   │
│  │  │ aiRouter()  │ │buildPrompt()│ │buildKeywordMap │ │   │
│  │  └─────────────┘ └─────────────┘ └────────────────┘ │   │
│  │  ┌──────────────────┐ ┌────────────────────────┐    │   │
│  │  │checkAutoSearch() │ │ getRelevantKBFiles()   │    │   │
│  │  └──────────────────┘ └────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              2. CORE LAYER (核心業務層)              │    │
│  │         handleMessage() + callGeminiWithRoute()     │    │
│  └──────────────────────┬──────────────────────────────┘    │
│                          │                                   │
│  ┌───────────────────────┼──────────────────────────────┐   │
│  │ 3. COMMAND │ 4. DATA │ 5. SYNC │ 6. UTIL │ 7. RECORD│   │
│  └───────────────────────┼──────────────────────────────┘   │
└─────────────────────────┼───────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
   ┌───────────┐   ┌───────────┐   ┌───────────┐
   │Google Sheet│   │Google Drive│   │Gemini File│
   │ (資料庫)   │   │ (PDF手冊)  │   │ API Cache │
   └───────────┘   └───────────┘   └───────────┘
```

---

## 📁 檔案結構

| 檔案名稱 | 用途 |
|----------|------|
| `linebot.gs` | 主程式碼 (單一檔案完整系統) |
| `CLASS_RULES.csv` | 產品型號定義與規格資料庫 |
| `Prompt.csv` | AI 系統 Prompt 設定 |

---

## 🔧 全域配置 (Global Configuration)

### 1. Sheet 名稱常數

```javascript
const SHEET_NAMES = { 
  RECORDS: "所有紀錄",       // 對話紀錄
  LOG: "LOG",                // 系統日誌
  PROMPT: "Prompt",          // AI Prompt 設定
  LAST_CONVERSATION: "上次對話", // 對話歷史快取
  QA: "QA",                  // 問答知識庫
  CLASS_RULES: "CLASS_RULES" // 產品規則定義
};
```

### 2. 快取鍵值

```javascript
const CACHE_KEYS = { 
  KB_URI_LIST: 'kb_list_v15_0',     // 知識庫 URI 清單
  KEYWORD_MAP: 'keyword_map_v1',    // 關鍵字映射表
  HISTORY_PREFIX: 'hist:',          // 對話歷史前綴
  ENTRY_DRAFT_PREFIX: 'entry_draft_', // 建檔草稿
  PENDING_QUERY: 'pending_query_'   // 待處理深度查詢
};
```

### 3. 系統設定

```javascript
const CONFIG = {
  MODEL_NAME: 'models/gemini-2.5-flash', // AI 模型
  MAX_OUTPUT_TOKENS: 8192,               // 最大輸出 Token
  HISTORY_PAIR_LIMIT: 10,                // 對話歷史保留對數
  CACHE_TTL_SEC: 3600,                   // 快取 TTL (1小時)
  DRAFT_TTL_SEC: 300                     // 草稿 TTL (5分鐘)
};
```

### 4. 必要的 Script Properties

| 屬性名稱 | 說明 | 必要性 |
|----------|------|--------|
| `GEMINI_API_KEY` | Gemini API 金鑰 | ✅ 必填 |
| `TOKEN` | LINE Channel Access Token | ✅ 必填 |
| `SPREADSHEET_ID` | Google Sheet ID (備援) | 選填 |
| `DRIVE_FOLDER_ID` | PDF 手冊資料夾 ID | 選填 |
| `ADMIN_USER_ID` | 管理員 LINE User ID | 選填 |
| `VIP_USER_ID` | VIP 圖片辨識用戶 ID | 選填 |
| `ALLOW_PUSH` | 是否允許主動推播 | 選填 |

---

## 🧠 核心功能模組

### 模組 1：知識庫同步 (syncGeminiKnowledgeBase)

**功能說明：**
- 將 Google Sheet 資料 (QA、CLASS_RULES) 和 Drive PDF 上傳至 Gemini File API
- 建立關鍵字動態映射表
- 自動排程 47 小時後重新同步

**觸發方式：**
- 指令 `/重啟` 或 `/reboot`
- 定時觸發器 (自動排程)

**資料處理流程：**
```
1. QA Sheet → 精選問答 (最優先)
2. CLASS_RULES Sheet → 分流處理
   ├── LS開頭 → 詳細機型規格
   └── 其他 → 通用術語定義
3. Drive PDF → 逐檔上傳 (沿用舊檔 or 新增)
4. 更新 PropertiesService 快取
```

**關鍵函式：**
- `uploadFileToGemini()` - Resumable Upload 上傳檔案
- `scheduleNextSync()` - 預約下次同步 (47小時後)

---

### 模組 2：智慧 RAG 搜尋 (getRelevantKBFiles)

**功能說明：**
- 讀取雙方最近 6 句對話建立上下文
- 透過 `KEYWORD_MAP` 進行關鍵字擴充
- 智慧選擇相關 PDF 掛載

**範例流程：**
```
使用者問：「Odyssey3D 怎麼設定」
    ↓
系統偵測到 Odyssey3D
    ↓
查表擴充：Odyssey3D → G90XF
    ↓
匹配 PDF：*G90XF*.pdf
```

---

### 模組 3：AI 策略 + [AUTO_SEARCH_PDF] 自動召喚機制

**核心概念：** 使用者不需手動輸入「1」，系統自動偵測並重試

**流程圖：**
```
使用者訊息
    ↓
aiRouter() 判斷路由
    ├── DIRECT (直通車關鍵字) → 強制附帶 PDF
    ├── DEEP (使用者輸入 1/深度) → 附帶 PDF
    └── FAST (預設) → 只用 Sheet
           ↓
    callGeminiWithRoute()
           ↓
    AI 回應包含 [AUTO_SEARCH_PDF]?
        ├── 是 → 自動重試 (isRetry=true) → 附帶 PDF
        └── 否 → 直接回覆使用者
```

| 階段 | 模式 | 掛載檔案 | 說明 |
|------|------|----------|------|
| Phase 1 | 極速模式 | Sheet 資料 | 快速回應，若不足則輸出 `[AUTO_SEARCH_PDF]` |
| Phase 2 | 自動深度 | Sheet + PDF | 系統攔截暗號後自動重試 |
| Phase 3 | 最終回答 | 全部 | 若仍無法回答，引導找 Sam |

**關鍵參數：**
- `isRetry`: 防止無限循環，重試模式下 Prompt 禁止再輸出暗號

**直通車 (強制深度)：**
```javascript
const strongKeywords = [
  "G90XF", "G95SC", "G80SD", "G81SF",
  "ViewFinity", "Smart Monitor", "OLED", "Odyssey3D"
];
```
當訊息包含以上關鍵字時，跳過極速模式，直接附帶 PDF。

---

### 模組 4：訊息處理流程 (handleMessage)

```
使用者訊息進入
    │
    ├─ 是否在建檔模式？ → handleDraftModification()
    │
    ├─ 是否為指令 (/)？ → handleCommand()
    │
    ├─ 是否為深度確認 (1/深度/查)？ → handleDeepSearch()
    │
    └─ 一般對話 → callChatGPTWithRetry()
           │
           ├─ 回應包含 [NEED_DOC]？
           │     └─ 顯示「深度搜尋」提示
           │
           └─ 儲存對話歷史
```

---

### 模組 5：建檔系統

**指令：**
- `/紀錄 <內容>` - 開始建檔
- `/紀錄` (無內容) - 存檔或自動整理 QA
- `/取消` - 取消建檔

**建檔類型：**

| 類型 | 目標 Sheet | 格式 |
|------|------------|------|
| QA | QA | 日期, 分類, 子分類, 問題, 答案, 來源 |
| Rule | CLASS_RULES | 關鍵字, 定義, 來源, 說明 |

**流程：**
```
1. 使用者輸入 /紀錄 <網頁文字>
2. AI 分析內容，產生 Draft JSON
3. 顯示預覽，等待確認或修改
4. 使用者輸入 /紀錄 → 存檔並同步知識庫
```

---

## 📡 LINE Webhook 入口

### doPost(e) 事件處理

**支援的訊息類型：**
- `text` - 文字訊息
- `image` - 圖片訊息 (僅限 VIP 用戶或一對一聊天)

**群組/聊天室規則：**
- 必須 @ 提及 Bot 才會回應
- 圖片辨識僅 VIP 用戶可用

**防重複處理：**
```javascript
function isDuplicateEvent(id) {
  const c = CacheService.getScriptCache();
  if(c.get(id)) return true;
  c.put(id,'1',60);
  return false;
}
```

---

## 🛠️ 工具函式

### 文字格式化

| 函式 | 功能 |
|------|------|
| `formatListSpacing()` | 強制列表排版 (每項後加空行) |
| `formatForLineMobile()` | LINE 手機版友善格式 (移除 Markdown) |
| `sanitizeForSheet()` | Sheet 安全格式 (移除換行、逗號轉全形) |

### 對話管理

| 函式 | 功能 |
|------|------|
| `getHistoryFromCacheOrSheet()` | 讀取對話歷史 (快取優先) |
| `updateHistorySheetAndCache()` | 更新對話歷史 (雙寫) |
| `clearHistorySheetAndCache()` | 清除對話歷史 |

### LINE API

| 函式 | 功能 |
|------|------|
| `replyMessage()` | 回覆訊息 (最長 4000 字) |
| `showLoadingAnimation()` | 顯示打字中動畫 |
| `getBotUserId()` | 取得 Bot User ID |

---

## 📊 資料庫結構

### Sheet: QA

| 欄位 | 說明 |
|------|------|
| A | 合併資料 (日期, 分類, 子分類, 問題, 答案, 來源) |

### Sheet: CLASS_RULES

| 欄位 | 說明 |
|------|------|
| A | 合併資料 (關鍵字, 定義, 來源, 說明) |

### Sheet: 所有紀錄

| 欄位 | 說明 |
|------|------|
| A | 時間戳記 |
| B | Context ID (群組/用戶 ID) |
| C | User ID |
| D | 訊息內容 |
| E | 角色 (user/assistant) |
| F | 標記 (DEEP_SEARCH, TRUE 等) |

### Sheet: LOG

| 欄位 | 說明 |
|------|------|
| A | 時間戳記 |
| B | 日誌內容 |

### Sheet: 上次對話

| 欄位 | 說明 |
|------|------|
| A | Context ID |
| B | JSON 格式對話歷史 |

### Sheet: Prompt

| 欄位 | 說明 |
|------|------|
| B3 | Temperature (建議 0.6) |
| C3 | System Prompt |

---

## 🚀 部署與初始化

### 步驟 1：設定 Script Properties

在 GAS 編輯器中：
`專案設定 → 指令碼屬性` 新增：

```
GEMINI_API_KEY = your_gemini_api_key
TOKEN = your_line_channel_access_token
DRIVE_FOLDER_ID = your_pdf_folder_id (選填)
```

### 步驟 2：建立 Webhook

1. 部署 GAS 為 Web App
2. 取得部署網址
3. 在 LINE Developers Console 設定 Webhook URL

### 步驟 3：初始化

執行 `runInitializeAndSync()` 函式：
- 自動建立所有必要的 Sheet
- 執行第一次知識庫同步

---

## 📝 指令清單

| 指令 | 功能 |
|------|------|
| `/重啟` 或 `/reboot` | 重置對話 + 同步知識庫 |
| `/紀錄 <內容>` | 開始建檔流程 |
| `/紀錄` | 存檔或自動整理 QA |
| `/取消` | 取消建檔模式 |

---

## 🔒 安全機制

1. **事件去重** - 60 秒內相同 eventId 不重複處理
2. **Script Lock** - 同步與寫入使用鎖定機制
3. **API 重試** - 最多 3 次指數退避重試
4. **Token 過大保護** - 自動偵測並回傳錯誤訊息
5. **知識庫自動修復** - 404 錯誤時自動清除快取重建

---

## 🎯 AI Prompt 設計重點

### 人格設定
- 角色：台灣三星電腦螢幕新手服務專員
- 語氣：朋友口吻，使用「你」，禁止「您」
- 結尾：自然收尾，適時加 emoji

### 回答限制
- 一般對話：200 字內
- 深度搜尋：500 字內

### 邏輯判斷
1. 查無資料 → 引導找 Sam
2. 商業機密 → 幽默拒絕
3. 硬體規格 → 必須交叉驗證
4. 模糊型號 → 必須詢問確認

### 關鍵暗號
- `[AUTO_SEARCH_PDF]` - 觸發自動深度搜尋（新機制）
- 舊版 `[NEED_DOC]` 已棄用

---

## 📚 LLM 回答邏輯歷程

詳細的 LLM 邏輯調整記錄請參閱 `LLM_LOGIC_HISTORY.md`

### 核心規則
1. **硬體判讀天條**：CLASS_RULES 沒寫 = 沒有此功能
2. **系列差異隔離**：禁止「G8 系列都有...」這類概括
3. **上下文讀取**：保留 3 輪（6 句）對話歷史
4. **查無資料**：引導找 Sam，禁止瞎掰

---

## 🐛 常見問題排除

| 問題 | 可能原因 | 解決方案 |
|------|----------|----------|
| API 回傳空白 | Token 過大 | 減少掛載 PDF 數量 |
| 404 錯誤 | 知識庫過期 | 執行 `/重啟` 重新同步 |
| 重複回覆 | 事件重複觸發 | 檢查 `isDuplicateEvent()` |
| 群組不回應 | 未 @ Bot | 確認 Mention 設定 |

---

## 📈 版本特色 (v22.0.0)

- ✅ **Brain-First 架構** - AI 邏輯集中於程式碼最前方（第 1 區塊）
- ✅ **自動召喚機制** - `[AUTO_SEARCH_PDF]` 暗號觸發自動深度搜尋
- ✅ **無限循環防護** - `isRetry` 參數防止重複觸發
- ✅ **上下文增強** - 讀取雙方最近 6 句支援連續追問
- ✅ **通用映射** - 透過 CLASS_RULES 自動建立關鍵字關聯
- ✅ **直通車機制** - 新型號強制附帶 PDF 手冊

---

## 📅 維護建議

1. **定期更新 CLASS_RULES** - 新產品上市時
2. **清理 LOG Sheet** - 避免資料過大
3. **監控 API 配額** - Gemini API 有使用限制
4. **備份 Script Properties** - 避免金鑰遺失

---

*最後更新：Version 22.0.0 Brain-First Architecture*
