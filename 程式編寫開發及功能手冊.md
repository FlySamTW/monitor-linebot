# Samsung LINE Bot å®Œæ•´æµç¨‹è§£æ (v29.5.48)

## ğŸ“‹ æ ¸å¿ƒå“²å­¸

AI å„ªå…ˆ (AI-First) + ç¨‹å¼è¼”åŠ© (Code-Assisted)

- AI åˆ¤æ–·èƒ½å›ç­” â†’ ç›´æ¥å›ç­”
- AI åˆ¤æ–·è³‡æ–™ä¸è¶³ â†’ è¼¸å‡ºæš—è™Ÿ â†’ ç¨‹å¼æ¥æ‰‹åŸ·è¡Œ

---

## ğŸ”„ å®Œæ•´æµç¨‹åœ–

```mermaid
graph TD
    User[ç”¨æˆ¶ç™¼é€è¨Šæ¯] --> API[1. è¨Šæ¯å…¥å£ (doPost)]
    API --> Handle[2. è¨Šæ¯åˆ†æµ (handleMessage)]

    Handle -- æŒ‡ä»¤/å»ºæª” --> Cmd[æŒ‡ä»¤/å»ºæª”æ¨¡å¼]
    Handle -- ä¸€èˆ¬å°è©± --> DirectCheck[3. ç›´é€šè»Šåµæ¸¬]

    DirectCheck -- å‘½ä¸­ CLASS_RULES --> CacheKey[æ³¨å…¥å‹è™Ÿè‡³ Cache]
    DirectCheck --> FastMode[4. æ¥µé€Ÿæ¨¡å¼]
    CacheKey --> FastMode

    subgraph Core[æ ¸å¿ƒå›ç­”é‚è¼¯]
        FastMode -- è¼‰å…¥ QA + RULES --> LLM1[å‘¼å« LLM (ç„¡ PDF)]
        LLM1 --> Decision{AI èƒ½å›ç­”?}

        Decision -- YES --> Reply[ç›´æ¥å›è¦†]
        Decision -- NO --> SignalCheck{è¼¸å‡ºæš—è™Ÿ?}

        SignalCheck -- AUTO_SEARCH_PDF --> PDFMode[5. PDF æ¨¡å¼]
        SignalCheck -- AUTO_SEARCH_WEB --> WebMode[6. ç¶²è·¯æœå°‹]

        subgraph PDFFlow[PDF æ™ºæ…§æµç¨‹]
            PDFMode --> PDFLoad[è¼‰å…¥ PDF (Max 1-2æœ¬)]
            PDFLoad --> LLM2[LLM é‡è©¦]
            LLM2 --> Reply
        end

        subgraph WebFlow[Web æœå°‹æµç¨‹]
            WebMode --> GoogleSearch[å•Ÿç”¨ Google Search]
            GoogleSearch --> LLM3[LLM é‡è©¦]
            LLM3 --> Reply
        end
    end
```

---

## ğŸ“š çŸ¥è­˜ä¾†æºå„ªå…ˆç´š (éµå¾‹)

1. ğŸ¥‡ **æœ€é«˜å„ªå…ˆ: QA è³‡æ–™åº« (QA.csv)**
   - ç²¾é¸å•ç­”ï¼Œé«˜å‘½ä¸­ç‡å¸¸è¦‹å•é¡Œ
2. ğŸ¥ˆ **ç¬¬äºŒå„ªå…ˆ: CLASS_RULES (è¦æ ¼åº«)**
   - å‹è™Ÿè¦æ ¼ + è¡“èªå®šç¾©
   - è‡ªå‹•ç”Ÿæˆ KEYWORD_MAP ä¾›æ“´å……
3. ğŸ¥‰ **ç¬¬ä¸‰å„ªå…ˆ: PDF æ‰‹å†Š (ä¸‰æ˜Ÿè¢å¹•ä½¿ç”¨æ‰‹å†Š/)**
   - è©³ç´°æ“ä½œæ­¥é©Ÿã€OSD è·¯å¾‘ã€æ•…éšœæ’é™¤
   - è§¸ç™¼æ¢ä»¶: `[AUTO_SEARCH_PDF]` æˆ–ç›´é€šè»Šå¼·åˆ¶
4. ğŸ† **æœ€å¾Œæ‰‹æ®µ: ç¶²è·¯æœå°‹ (Google Search)**
   - å®Œå…¨ç„¡è§£æ™‚çš„å‚™æ´
   - è§¸ç™¼æ¢ä»¶: `[AUTO_SEARCH_WEB]` æˆ–ç”¨æˆ¶å¼·åˆ¶ /æ“´å¤§æœå°‹

---

## ğŸ”‘ é—œéµæš—è™Ÿç³»çµ±

| æš—è™Ÿ                | è§¸ç™¼æ™‚æ©Ÿ              | ç³»çµ±è¡Œç‚º                          |
| ------------------- | --------------------- | --------------------------------- |
| `[AUTO_SEARCH_PDF]` | QA/è¦æ ¼ä¸è¶³ï¼Œéœ€æŸ¥æ‰‹å†Š | è¼‰å…¥å°æ‡‰ PDFï¼Œé‡æ–°å‘¼å« LLM        |
| `[AUTO_SEARCH_WEB]` | PDF ä¹Ÿæ²’ç­”æ¡ˆï¼Œéœ€è¯ç¶²  | å•Ÿç”¨ Google Search å·¥å…·ï¼Œå‘¼å« LLM |
| `[NEW_TOPIC]`       | AI åˆ¤æ–·æ›é¡Œ           | æ¸…é™¤ PDF Modeï¼Œé‡ç½®ä¸Šä¸‹æ–‡         |
| `[å‹è™Ÿ:xxx,yyy]`    | AI å»ºè­°å¤šå‹è™Ÿ         | è‡ªå‹•ç”Ÿæˆ Quick Reply é¸å–®         |

---

## ğŸ¯ å‹è™ŸåŒ¹é…é‚è¼¯ (Smart Router v29.5.48)

ç”¨æˆ¶è¼¸å…¥: "S27AG500NC æ€éº¼è¨­å®š"

1. **ç›´é€šè»Šåµæ¸¬**: å‘½ä¸­ "G5" (åˆ¥ç¨±)
   - ç³»çµ±æ³¨å…¥: G5, S27FG532EC, S27DG502EC...

2. **Smart Router åˆ¤æ–· (v29.5.48 New)**:
   - **å–®ä¸€å‹è™Ÿ**: è‡ªå‹•é–å®šï¼Œè¼‰å…¥ 1 æœ¬ PDFã€‚
   - **å¤šå‹è™Ÿ (æ¯”è¼ƒ/åˆ—è¡¨é¡Œ)**:
     - è‹¥ç”¨æˆ¶å•ã€Œå“ªä¸€å°...ã€ã€ã€Œæ¨è–¦...ã€ (List Intent) â†’ **è·³éæ³¡æ³¡**ï¼Œè®“ AI ç›´æ¥åˆ—å‡ºã€‚
     - è‹¥åƒ…æ˜¯æ¨¡ç³ŠæŸ¥è©¢ â†’ é¡¯ç¤º **å‹è™Ÿé¸æ“‡æ³¡æ³¡**ã€‚
   - **æ•¸é‡éå¤š**: è‹¥å€™é¸ > 10 å€‹ â†’ è·³éæ³¡æ³¡ï¼Œé¿å…æ´—ç‰ˆã€‚

3. **ç²¾æº–åŒ¹é…**:
   - æ‰¾åˆ° `S27AG500NC.pdf`
   - è¼‰å…¥ PDF â†’ LLM å›ç­”è¨­å®šæ­¥é©Ÿ

---

## ğŸ›¡ï¸ å®‰å…¨é˜²è­·æ©Ÿåˆ¶

1. **æºé ­æ¸›é‡**
   - éæ¯”è¼ƒé¡Œ: å¼·åˆ¶ 1 æœ¬ PDF
   - æ¯”è¼ƒé¡Œ: æœ€å¤š 2 æœ¬ PDF
2. **é‡è©¦ç­–ç•¥ (callLLMWithRetry)**
   - Retry 1: ç§»é™¤ç¬¬ 2 æœ¬ PDF
   - Retry 2: ç§»é™¤æ‰€æœ‰ PDF (çµ‚æ¥µé™ç´š)
   - Retry 3: æ”¾æ£„ï¼Œå›å‚³éŒ¯èª¤è¨Šæ¯
3. **Token ç†”æ–·**
   - é ä¼° > 40K tokens
   - è£åˆ‡æ­·å²ï¼Œä¿ç•™æœ€æ–° 2 å°å°è©±
4. **äº‹ä»¶å»é‡**
   - ç›¸åŒ eventId 60 ç§’å…§ä¸é‡è¤‡è™•ç†

---

## ğŸ“Š è³‡æ–™æµå‹•ç¤ºæ„

```
Google Sheet â”€â”€â”€â”€â”€â”€â–º Cache â”€â”€â”€â”€â”€â”€â–º GAS
   â”‚                   â”‚            â”‚
   â”œâ”€ QA              â”‚            â”œâ”€ buildDynamicContext()
   â”œâ”€ CLASS_RULES     â”‚            â”œâ”€ getRelevantKBFiles()
   â””â”€ Prompt          â”‚            â”œâ”€ callLLMWithRetry()
                       â”‚            â””â”€ replyMessage()
                       â”‚
Google Drive â”€â”€â”€â”€â”€â”€â–º Gemini File API
   â”‚                               â”‚
   â””â”€ PDF æ‰‹å†Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
