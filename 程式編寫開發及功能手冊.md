# Samsung LINE Bot 完整流程解析 (v29.5.141)

## 📋 核心哲學

AI 優先 (AI-First) + 程式輔助 (Code-Assisted)

- AI 判斷能回答 → 直接回答
- AI 判斷資料不足 → 輸出暗號 → 程式接手執行

---

## 🔄 完整流程圖

```mermaid
graph TD
    User[用戶發送訊息] --> API[1. 訊息入口 (doPost)]
    API --> Handle[2. 訊息分流 (handleMessage)]

    Handle -- 指令/建檔 --> Cmd[指令/建檔模式]
    Handle -- 一般對話 --> DirectCheck[3. 直通車偵測]

    DirectCheck -- 命中 CLASS_RULES --> CacheKey[注入型號至 Cache]
    DirectCheck --> FastMode[4. 極速模式]
    CacheKey --> FastMode

    subgraph Core[核心回答邏輯]
        FastMode -- 載入 QA + RULES --> LLM1[呼叫 LLM (無 PDF)]
        LLM1 --> Decision{AI 能回答?}

        Decision -- YES --> Reply[直接回覆]
        Decision -- NO --> SignalCheck{輸出暗號?}

        SignalCheck -- AUTO_SEARCH_PDF --> PDFMode[5. PDF 模式]
        SignalCheck -- AUTO_SEARCH_WEB --> WebMode[6. 網路搜尋]

        subgraph PDFFlow[PDF 智慧流程]
            PDFMode --> PDFLoad[載入 PDF (Max 1-2本)]
            PDFLoad --> LLM2[LLM 重試]
            LLM2 --> Reply
        end

        subgraph WebFlow[Web 搜尋流程]
            WebMode --> GoogleSearch[啟用 Google Search]
            GoogleSearch --> LLM3[LLM 重試]
            LLM3 --> Reply
        end
    end
```

---

## 📚 知識來源優先級 (鐵律)

1. 🥇 **最高優先: QA 資料庫 (QA.csv)**
   - 精選問答，高命中率常見問題
2. 🥈 **第二優先: CLASS_RULES (規格庫)**
   - 型號規格 + 術語定義
   - 自動生成 KEYWORD_MAP 供擴充
3. 🥉 **第三優先: PDF 手冊 (三星螢幕使用手冊/)**
   - 詳細操作步驟、OSD 路徑、故障排除
   - 觸發條件: `[AUTO_SEARCH_PDF]` 或直通車強制
   - **智慧過濾**: 若型號不在 `PDF_MODEL_INDEX` 中，會自動跳過此階以節省 Token。
4. 🏆 **最後手段: 網路搜尋 (Google Search)**
   - 完全無解時的備援
   - 觸發條件: `[AUTO_SEARCH_WEB]` 或用戶強制 /擴大搜尋

---

## 📖 實戰流程範例：以 "G5 怎麼設定" 為例

當用戶輸入關鍵字後，系統會自動評估路徑：

### 情境 A：型號無專屬手冊 (例：S27AG500NC)

1. **Pass 1 (規格)**：命中別稱 G5，AI 輸出 `[AUTO_SEARCH_PDF: G5]`。
2. **型號精確化**：系統彈出泡泡，用戶選擇 `S27AG500NC`。
3. **智慧分流 (SOP)**：系統檢查 `PDF_MODEL_INDEX` 發現無專屬手冊。
4. **自動降級**：直接使用 **規格庫** 內容回答基礎資訊，標註 `[來源: 規格庫]`。
5. **備援路徑**：若用戶點擊「不滿意」，則進入 **Pass 2 (Web Search)**。

### 情境 B：型號有專屬手冊 (例：S32DG502)

1. **Pass 1 (規格)**：同上，AI 輸出暗號。
2. **型號精確化**：用戶選擇 `S32DG502`。
3. **PDF 鎖定**：系統發現有專屬手冊，啟動 **Pass 1.5 (PDF Search)**。
4. **精準回答**：載入 PDF 並由 AI 產出詳細設定步驟，標註 `[來源: 產品手冊]`。

---

## 🔑 關鍵暗號系統

| 暗號                | 觸發時機              | 系統行為                          |
| ------------------- | --------------------- | --------------------------------- |
| `[AUTO_SEARCH_PDF]` | QA/規格不足，需查手冊 | 載入對應 PDF，重新呼叫 LLM        |
| `[AUTO_SEARCH_WEB]` | PDF 也沒答案，需聯網  | 啟用 Google Search 工具，呼叫 LLM |
| `[NEW_TOPIC]`       | AI 判斷換題           | 清除 PDF Mode，重置上下文         |
| `[型號:xxx,yyy]`    | AI 建議多型號         | 自動生成 Quick Reply 選單         |

---

## 🎛️ Quick Reply 按鈕系統 (v29.5.140)

每次 AI 回覆後，LINE 訊息底部附帶 Quick Reply 按鈕。按鈕 text 以 `#` 開頭，由 handleMessage 中的 handler 攔截。

### 按鈕配置（動態，不是固定三顆）

| 按鈕 | text | 顯示條件 | 處理方式 |
|------|------|----------|----------|
| 💬 再詳細說明 | `#再詳細說明` | 該題展開次數 `< 2` | 改寫 msg 後**不 return**，走正常對話流程 |
| 📖 查手冊 | `#查手冊` | 一般回覆：`hasPdfForModel && !alreadyConsultedPdf`；Web 回合：有型號記憶 (`direct_search_models`) | 獨立 handler，從歷史找問題 → PDF → LLM |
| 🌐 這題再搜網路 | `#這題再搜網路` | 一般回覆永遠顯示；Web 回合也保留 | 呼叫 handleCommand 觸發同題 Web Search |

### 指令相容性（避免舊按鈕失效）

- 新指令：`#這題再搜網路`
- 相容舊指令：`#搜尋網路`、`#搜網上其他解答`、`#搜往上其他解答`

### 動態決策矩陣（實際行為）

- QA/規格回覆，且可查手冊：通常 3 顆（再詳細 / 查手冊 / 這題再搜網路）
- 已達「再詳細說明」上限：隱藏「再詳細說明」
- 無可用型號或無手冊：隱藏「查手冊」，並在**對話內容**提示「請提供完整型號」
- Web 回合：不再硬編碼只留 1 顆，會依上述條件動態保留 2~3 顆

### `#再詳細說明` 流程詳解

```
用戶按按鈕 → LINE 發送 "#再詳細說明"
  ↓
handler 改寫 msg = "請針對你剛才的回答再詳細說明..."
handler 改寫 userMessage = 同上
(⚠️ 禁止設 userMsgObj — TDZ 會報錯)
handler 不 return
  ↓
D. 一般對話:
  history = getHistoryFromCacheOrSheet(contextId) ← 5 輪歷史
  const userMsgObj = { role: "user", content: msg } ← 基於改寫後的 msg
  ↓
callLLMWithRetry(userMessage, [...history, userMsgObj], ...)
  AI 看到完整歷史 + 「請再詳細說明」指令 → 自然展開回答
```

**設計原則**: 系統已保留 5 輪對話歷史，AI 本來就看得到上次完整回答，不需要手動從歷史提取截斷。

### `hasPdfForModel` 與手冊按鈕控制邏輯

```
DirectDeep 命中關鍵字
  ↓
從 directSearchResult.models 取得型號列表
  ↓
對照 PDF_MODEL_INDEX (ScriptProperties)
  ↓
有 PDF → hasPdfForModel = true → 顯示「📖 查手冊」按鈕
無 PDF → hasPdfForModel = false → 隱藏按鈕
```

補充（v29.5.139）：

- 在「#這題再搜網路」回合，若同題已保留型號記憶 (`direct_search_models`)，仍保留「📖 查手冊」入口，避免泡泡縮到只剩 1 顆。

---

## 🎯 型號匹配邏輯 (Smart Router v29.5.48)

用戶輸入: "S27AG500NC 怎麼設定"

1. **直通車偵測**: 命中 "G5" (別稱)
   - 系統注入: G5, S27FG532EC, S27DG502EC...

2. **Smart Router 判斷 (v29.5.48 New)**:
   - **單一型號**: 自動鎖定，載入 1 本 PDF。
   - **多型號 (比較/列表題)**:
     - 若用戶問「哪一台...」、「推薦...」 (List Intent) → **跳過泡泡**，讓 AI 直接列出。
     - 若僅是模糊查詢 → 顯示 **型號選擇泡泡**。
   - **數量過多**: 若候選 > 10 個 → 跳過泡泡，避免洗版。

3. **精準匹配**:
   - 找到 `S27AG500NC.pdf`
   - 載入 PDF → LLM 回答設定步驟

---

## 🛡️ 安全防護機制

1. **源頭減量**
   - 非比較題: 強制 1 本 PDF
   - 比較題: 最多 2 本 PDF
2. **重試策略 (callLLMWithRetry)**
   - Retry 1: 移除第 2 本 PDF
   - Retry 2: 移除所有 PDF (終極降級)
   - Retry 3: 放棄，回傳錯誤訊息
3. **Token 熔斷**
   - 預估 > 40K tokens
   - 裁切歷史，保留最新 2 對對話
4. **事件去重**
   - 相同 eventId 60 秒內不重複處理

---

## 📊 資料流動示意

```
Google Sheet ──────► Cache ──────► GAS
   │                   │            │
   ├─ QA              │            ├─ buildDynamicContext()
   ├─ CLASS_RULES     │            ├─ getRelevantKBFiles()
   └─ Prompt          │            ├─ callLLMWithRetry()
                       │            └─ replyMessage()
                       │
Google Drive ──────► Gemini File API
   │                               │
   └─ PDF 手冊 ───────────────────┘
```

---

## 🗂️ 型號索引系統 (v29.5.53 新增)

`/重啟` 後，系統會建立兩個重要索引，供後續邏輯判斷使用：

| 索引名稱            | 來源               | 儲存位置         | 用途                          |
| ------------------- | ------------------ | ---------------- | ----------------------------- |
| `TOTAL_MODEL_COUNT` | CLASS_RULES 規格庫 | ScriptProperties | 統計有規格資料的型號總數      |
| `PDF_MODEL_INDEX`   | PDF 手冊檔名       | ScriptProperties | 記錄有專屬 PDF 手冊的型號清單 |

### 應用場景

1. **避免載入錯誤 PDF**：
   - 若用戶查詢 `S27AG500NC`，但 `PDF_MODEL_INDEX` 中不存在該型號
   - 系統會 Log 警告：`⚠️ 型號 S27AG500NC 無專屬 PDF，將使用 Alias 匹配`
   - 程式可據此決定是否跳過 PDF 載入，或改用其他策略

2. **Smart Router 選項過濾**：
   - 在顯示型號選擇泡泡時，可剔除「無規格」或「無 PDF」的選項
   - 提升用戶體驗，避免選到無法回答的型號

3. **預先規劃搜尋路徑**：
   - 若型號同時存在於規格庫與 PDF 索引 → 優先用規格庫 (省 Token)
   - 若僅存在規格庫 → 跳過 PDF 載入步驟
   - 若僅存在 PDF 索引 → 直接進入 PDF 模式

---

## 📜 版本更新紀錄

### v29.5.141 (2026-03-02)

- **Fix (Critical)**: 同步全域 `MODEL_REGEX`，確保 `DirectDeep` 與相關邏輯能正確提取 `WA/WD/VR` 等家電型號，解決洗衣機提問無法觸發型號選擇泡泡的問題。
+
+### v29.5.140 (2026-03-02)
+
+- **Fix (Logic)**: 修復 `[型號:xxx]` 標籤在非暗號對話中外洩的問題（清理邏輯移出 Trigger 判斷）。
+- **Feat (Prompt)**: 強制所有長度回答皆須標註來源。
+- **Feat (Prompt)**: 系列導航增加明確反問引導語。
+- **Feat (Prompt)**: 當 PDF 查無精確規格（如耗電量）時，強制轉入 `[AUTO_SEARCH_WEB]`。
+

### v29.5.139 (2026-02-12)

- **Fix (UX)**: Web 回合不再硬編碼只剩 1 顆泡泡，改為依條件動態顯示 2~3 顆。
- **Feat (UX)**: 「🌐 搜尋這題的網路解答」文案調整為「🌐 這題再搜網路」。
- **Compat**: 新增 `#這題再搜網路`，並保留舊指令 `#搜尋網路` / `#搜網上其他解答` / `#搜往上其他解答`。
- **Obs**: 新增 Web 回合泡泡數日誌：`[Quick Reply v29.5.139] 這題再搜網路回合泡泡數: N`。

### v29.5.129 (2026-02-09)

- **Fix (Critical)**: 修復 `#再詳細說明` handler 中 `userMsgObj = {...}` 在 `const userMsgObj` 宣告前賦值，V8 TDZ 導致 `ReferenceError`。移除多餘賦值行，只改寫 `msg` 和 `userMessage`。

### v29.5.127 (2026-02-09)

- **Feat (UX)**: `#繼續問` 更名為 `#再詳細說明`，語意更精確。
- **Feat (UX)**: `#查手冊` 按鈕加入 30 秒等待提示。
- **Fix (Logic)**: 修復 Web 搜尋回應中 `[來源: 網路搜尋]` 重複出現（LLM 加一次 + 程式加一次）。

### v29.5.126 (2026-02-09)

- **Fix (Critical)**: 修復不存在型號（如 S32FD812）被 AI 幻覺回答。在 Prompt.csv 新增【型號驗證】規則。

### v29.5.123 (2026-02-07)

- **Feat (UX)**: 「📖 查PDF手冊」按鈕改為條件顯示，只在 `hasPdfForModel = true` 時出現。DirectDeep 階段預載 PDF_MODEL_INDEX。

### v29.5.53 (2026-01-19 13:25)

- **Feat (Index)**: 新增「PDF 型號索引 (`PDF_MODEL_INDEX`)」機制。
  - 在 `/重啟` 時從所有 PDF 檔名中提取型號，建立索引。
  - 在 `getRelevantKBFiles` 中查詢索引，若型號無專屬 PDF 則 Log 警告。
  - 重啟訊息新增 `PDF索引: N` 顯示提取到的型號數量。

### v29.5.52 (2026-01-19 13:15)

- **Feat (UX)**: 優化 Quick Reply (擴大搜尋) 引導按鈕。
  - **情境感知**:
    - **Fast Mode (規格)**: 按鈕文字「不滿意 (查手冊)」，預告需虛耗 30 秒。
    - **PDF Mode**: 按鈕文字「不滿意 (搜網路)」，引導至外部搜尋。
    - **Web Mode**: 按鈕文字「不滿意 (繼續搜)」，嘗試更多網路來源。

### v29.5.51 (2026-01-19 13:10)

- **Fix (Logic)**: PDF 載入邏輯重大修正。
  - **Revert**: 撤銷 v29.5.49 的別名阻擋邏輯，確保 `G5` 別名能被擴展，避免因 PDF 檔名僅含別名而找不到檔案。
  - **New**: 新增「智慧權重排序 (Smart Prioritization)」，在 Tier 1 內若同時找到多個 PDF，優先選用包含「完整型號 (S27AG500NC)」的檔案，其次為「S開頭型號」，最後才選「別名 (G5)」。
- **Fix (UX)**: 修正 Web 搜尋失敗導致的回應空白問題（透過確保 PDF 載入成功來根治）。

### v29.5.50 (2026-01-19 13:05)

- **Feat (UX)**: 新增「動態泡泡 (Dynamic Bubble)」功能。
  - 根據用戶問句意圖（規格/手冊/價格），自動調整 Smart Router 泡泡的標題與說明文字。
  - 例如問「價格」，泡泡會顯示「查詢價格/通路」；問「設定」，顯示「查閱產品手冊」。

### v29.5.49 (2026-01-19 12:55)

- **Fix (Critical)**: 修復 `getRelevantKBFiles` 中 `primaryModel` 變數在初始化前被呼叫導致的 `ReferenceError` 崩潰問題。
- **Fix (UX)**: 修正型號選擇泡泡按鈕回傳值。由原本的「[型號] 怎麼設定」改為僅回傳「[型號]」，讓 AI 能正確銜接上下文回答用戶的原問題（如「寬度」），而非強制回答設定步驟。
- **Fix (Logic)**: 優化別名擴展邏輯。當用戶已指定明確型號（如 S27AG500NC）時，不再擴展寬泛別名（如 G5），避免載入錯誤的 PDF。

### v29.5.48 (2026-01-19 11:45)

- **Fix (UX)**: 針對通用問題（如「哪一台...」、「推薦...」或候選數 > 10），跳過 Smart Router 泡泡，讓 AI 直接列出清單。
