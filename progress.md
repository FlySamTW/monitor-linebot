# 專案進度報告 (2025-12-18 11:35)

## ✅ 已完成功能 (Completed Features)

### v27.9.3 (Token 優化與比較邏輯修正) - 已部署 ✅
1.  **buildDynamicContext 優化**
    - 改用「每個關鍵字獨立配額」機制（每個 6 行，總上限 50 行）
    - 解決 M8 佔滿配額導致 M9 規則被丟棄的問題
    - 避免觸發 5 萬 Token 的完整注入後備機制

2.  **nonPdfPatterns 精準化**
    - 移除「比較|差異|不同」關鍵字攔截
    - 允許比較題在 Fast Mode 無解時進入 PDF Mode
    - 保留其他通識知識攔截規則（如「什麼是」、「耳機孔」等）

3.  **getRelevantKBFiles 智慧型號鎖定**
    - 偵測比較意圖時保留所有型號（允許載入多本 PDF）
    - 一般問題維持單一型號鎖定（節省成本）
    - 新增比較意圖偵測：`/比較|差異|不同|vs/i`

---

### v27.8.32 (Root Cause Fixed) - 已部署
- 語法錯誤修復、極速模式聯網搜尋、來源標註系統等

---

## 📋 下一步計劃 (Next Steps)
1.  **部署新版本**：`clasp push`
2.  **功能驗證**：
    - 測試「M8和M9的差別」→ 確認同時偵測兩個型號
    - 測試超過 4 個型號 → 確認提示用戶
    - 測試型號切換場景 → 確認 Token 在合理範圍

---

## 💡 重要決策 (Key Decisions)
| 決策 | 原因 |
|------|------|
| 型號上限設為 4 個 | 2 本 PDF × 2 系列 = 合理的 Token 消耗範圍 |
| 使用實際 Token 而非預估 | 用戶要求：完全依照實際 Token 數 |
| forceCurrentOnly 參數 | 避免歷史型號（如 M5, M7）污染當前查詢的 PDF 匹配 |

---

## ⚠️ 注意事項 (Notes)
- **版本控制**：有效版本已更新至 **v27.9.0**
