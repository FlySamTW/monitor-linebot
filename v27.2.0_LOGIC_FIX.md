# v27.2.0：邏輯重構 - 解除 Deep Mode 嚴格禁令

## 🎯 修復目標
解決自 v26.4.0 起，Deep Mode (PDF 搜尋) 出現 **空白回應 / Emoji 回應** 的致命問題。

## 🕵️ 根本原因分析

### 兇手身份確認：v26.5.0 引入的邏輯矛盾

#### Rule 衝突
```
Rule 2b (v26.5.0)：「禁止猜測或用通用知識代替 PDF 內容」← 絕對禁令
Rule 6 (原本):   「嘗試通用知識回答，並標註來源」← 寬容退路
```

#### 發作機制
1. **情景**：用戶在 Deep Mode 提問，但 PDF 中找不到精確匹配的關鍵字
2. **AI 的困境**：
   - 想用 PDF 內容 → 找不到
   - 想用通用知識 → Rule 2b 說「絕對禁止」
   - 系統要求「不能空白回答」
3. **結果**：AI 在「必須回答」與「禁止回答」間當機，吐出 emoji (🎉) 作為逃生門

### 為何 v26.3 正常？
**因為沒有「禁止通用知識」這條禁令。** 當 PDF 查不到，AI 會自然退回到通用知識（並標註來源），這就是您說「以前明明可以」的原因。

### 臨床表現
- **消耗大量 Token**（~66k）卻無實質輸出
- **輸出為空白或單個 Emoji**
- **Problem：** 不是模型問題，而是 Prompt 邏輯自我矛盾

## 🛠️ 修復方案

### 方案核心：邏輯回滾 + 架構保留

#### 1. Prompt.csv 修改（Rule 2b）
**原文（v27.1.0）：**
```csv
深度模式已掛載 PDF，應直接從手冊提取，如果 PDF 真的無相關內容，才說「手冊沒寫」
（禁止猜測或用通用知識代替 PDF 內容）。
```

**新文（v27.2.0）：**
```csv
深度模式已掛載 PDF，應優先從手冊提取；若手冊無資料，則依據第 6 點嘗試通用知識回答（需標註來源）。
```

**邏輯變化：**
- ❌ 移除：「禁止猜測或用通用知識」
- ✅ 加入：「若無資料，則依據第 6 點嘗試通用知識」
- ✅ 保留：標註來源的要求（確保透明度）

#### 2. linebot.gs 同步修改
**Deep Mode 注入指令更新（第 2030 行左右）：**

**原文：**
```javascript
3. 如果找不到，說「手冊中沒有相關說明，建議找 Sam」
```

**新文：**
```javascript
3. 如果找不到，說「手冊中沒有相關說明」，並嘗試用通用知識補充（需標註來源）
```

## 📊 修復對比表

| 維度 | v26.3（正常） | v26.5-v27.1（破損） | v27.2（修復） |
|------|-----------|------------|----------|
| **PDF 無結果時** | Fallback 通用知識 + 來源標註 | 禁止通用知識 → 當機 → Emoji | Fallback 通用知識 + 來源標註 |
| **邏輯完整性** | ✅ 有完整退路 | ❌ 禁令陷阱 | ✅ 有完整退路 |
| **Token 消耗** | 適度 | 浪費（無輸出） | 適度 |
| **用戶體驗** | 問有答 | 問有 Emoji | 問有答 |

## 🔍 關鍵改進細節

### 保留的必要約束（來自 v26.5 的合理部分）
- ✅ 操作步驟「因型號而異」，優先 PDF 而非通用知識
- ✅ 規格問題必須查 CLASS_RULES，不能亂編
- ✅ 來源標註：確保所有通用知識都有明確標記

### 解除的有害限制
- ❌ 「禁止使用通用知識」← 導致當機
- ❌ 「絕對不能」的強硬措辭 ← 凍結了 AI 的應變能力

## 📝 Test Case 預期

### 測試場景：Deep Mode 問題且 PDF 無精確內容

**問題：** 「怎樣用 M8 做視訊會議？」

**預期回應（v27.2）：**
```
根據產品手冊，M8 的視訊鏡頭設定步驟是...【來源: 產品手冊】

如果你想用特定軟體（如 Zoom、Teams），可以...【來源: 非三星官方】
```

**不再出現：**
- ❌ 單個 Emoji
- ❌ 空白回應
- ❌ Token 浪費無輸出

## 🚀 版本記錄

| 版本 | 日期 | 改動 |
|------|------|------|
| v26.3.0 | 2025-12-08 | 基準線（正常） |
| v26.4.0 | 2025-12-08 | 加入「操作問題清單」 |
| v26.5.0 | 2025-12-08 | **[中毒]** 加入「禁止通用知識」禁令 |
| v26.7.0 | 2025-12-08 | 症狀處理：強制 50 字回答 |
| v26.8.0 | 2025-12-08 | 移除 50 字限制（但根本問題未解） |
| v27.0.0 | 2025-12-08 | 移除 Thinking Mode（錯誤方向） |
| v27.1.0 | 2025-12-08 | 移除字數限制（治標不治本） |
| **v27.2.0** | **2025-12-08** | **[修復]** 邏輯重構，解除禁令，恢復 Fallback 機制 |

## 💡 經驗總結

### 為什麼這次修復有效
1. **診斷正確**：找到了邏輯矛盾（不是模型問題、不是配置問題）
2. **方案精準**：不是盲目移除限制，而是有理由地恢復合理的退路
3. **保留約束**：依然要求 PDF 優先、來源標註，確保品質

### 危險信號（下次避免）
- ❌ 引入「禁止 X」的時候，要確保 AI 有完整的替代方案
- ❌ 不要用強硬措辭（「絕對」「禁止」）without fallback
- ❌ Prompt 的「保護規則」如果沒有「退路」，就會變成「當機規則」

