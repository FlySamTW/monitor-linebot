# v27.2.1ï¼šç·Šæ€¥ä¿®å¾© - API è§£æç•¶æ©Ÿ (Scope Error)

## ğŸš¨ è‡´å‘½å•é¡Œ
v27.2.0 éƒ¨ç½²å¾Œï¼Œ**æ‰€æœ‰ AI å›æ‡‰éƒ½è¿”å›ç©ºç™½**ï¼Œæ—¥èªŒé¡¯ç¤ºï¼š
```
[API Parse Error] usage is not defined
[Error] AI å›å‚³ç‚ºç©º
```

## ğŸ” æ ¹æœ¬åŸå› 

**åœ¨ `callChatGPTWithRetry()` ä¸­ï¼Œç¬¬ 2150 è¡Œå·¦å³çš„ä»£ç¢¼ï¼š**

```javascript
if (json.usageMetadata) {
    const usage = json.usageMetadata;  // â† åœ¨ if block å…§å®šç¾©
    // ... è¨ˆç®— token å’Œè²»ç”¨ ...
}

// ... ç¨å¾Œ ...

if (attachPDFs && candidates.length > 0 && candidates[0].content) {
    const responseText = candidates[0].content.parts[0].text || '';
    if (usage && usage.candidatesTokenCount <= 2) {  // âŒ é€™è£¡ usage æœªå®šç¾©ï¼
        // ...
    }
}
```

**å•é¡Œï¼š** `usage` è®Šæ•¸åœ¨ `if (json.usageMetadata)` block å…§ç”¨ `const` å®šç¾©ï¼Œscope åªé™æ–¼è©² block å…§ã€‚å¤–é¢çš„ä»£ç¢¼ç„¡æ³•å­˜å–ï¼Œå°è‡´ **ReferenceError: usage is not defined**ï¼Œæ•´å€‹ API å›æ‡‰è§£æéƒ½ç•¶æ©Ÿäº†ã€‚

## âœ… ä¿®å¾©æ–¹æ¡ˆ

**æ”¹ç‚ºåœ¨ block å¤–å®šç¾© `usage`ï¼Œä½¿å…¶æœ‰å…¨å±€ scopeï¼š**

```javascript
// ğŸ“Š Token ç”¨é‡ç´€éŒ„
let usage = null;  // â† æå‰å®šç¾©ï¼Œscope æ¶µè“‹æ•´å€‹ try block

if (json.usageMetadata) {
    usage = json.usageMetadata;  // â† è³¦å€¼ï¼Œä¸å†ç”¨ const
    // ... è¨ˆç®— token å’Œè²»ç”¨ ...
} else {
    // ...
    lastTokenUsage = null;
}

// ç¾åœ¨ usage å¯ä»¥åœ¨æ•´å€‹ scope å…§ä½¿ç”¨
if (attachPDFs && usage && usage.candidatesTokenCount <= 2) {
    // ... æ­£ç¢ºåŸ·è¡Œ
}
```

## ğŸ“Š ä¿®å¾©å½±éŸ¿

| æ–¹é¢ | v27.2.0 | v27.2.1 |
|------|---------|---------|
| **API è§£æ** | âŒ ç•¶æ©Ÿæ–¼ `usage is not defined` | âœ… æ­£å¸¸åŸ·è¡Œ |
| **AI å›æ‡‰** | âŒ ç©ºç™½ | âœ… æ­£å¸¸å›ç­” |
| **Token è¨ˆç®—** | âŒ å¤±æ•— | âœ… æˆåŠŸè¨˜éŒ„ |
| **ç”¨æˆ¶é«”é©—** | âŒ ç„¡å›ç­” | âœ… æ¢å¾©æ­£å¸¸ |

## ğŸ”§ é—œæ–¼é‡å•Ÿæ’ç¨‹çš„å»¶é²

å¦å¤–å›ç­”ä½ çš„å•é¡Œï¼š**ç‚ºä»€éº¼åœ¨ 19:00 å°–å³°æ™‚æ®µå»åŸ·è¡Œ `/é‡å•Ÿ`ï¼Ÿ**

æ ¹æ“šæ—¥èªŒï¼Œç³»çµ±è¨­å®šçš„è‡ªå‹•æ’ç¨‹æ˜¯ **æ¯æ—¥ 04:00 (å°åŒ—æ™‚é–“)**ï¼Œä½†ç”¨æˆ¶åœ¨ 19:00 æ™‚æ‰‹å‹•åŸ·è¡Œäº† `/é‡å•Ÿ` æŒ‡ä»¤ï¼ˆå¯èƒ½æ˜¯åœ¨æ¸¬è©¦æˆ–æ’é™¤å•é¡Œï¼‰ã€‚é€™æ˜¯é æœŸè¡Œç‚ºï¼Œæ’ç¨‹æœ¬èº«æ²’å•é¡Œã€‚

```
ğŸ•’ å·²è¨­å®šæ¯æ—¥ 04:00 (å°åŒ—æ™‚é–“) è‡ªå‹•é‡å»ºçŸ¥è­˜åº«
```

## ğŸš€ ç‰ˆæœ¬ç·š

| ç‰ˆæœ¬ | ä¿®å¾©å…§å®¹ |
|------|----------|
| v27.2.0 | é‚è¼¯é‡æ§‹ï¼ˆè§£é™¤ Deep Mode ç¦ä»¤ï¼‰ï¼Œä½†å¼•å…¥ scope bug |
| **v27.2.1** | **[ç·Šæ€¥ä¿®å¾©] è®Šæ•¸ scope éŒ¯èª¤ï¼Œæ¢å¾© API è§£æ** |

