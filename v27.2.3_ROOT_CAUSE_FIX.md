# v27.2.3：致命修復 - Deep Mode 搜尋工具導致空白/Emoji 回應

## 🚨 根本原因找到！

日誌清晰展示問題：

```
[API Call] Model: models/gemini-2.0-flash, PDF: true, Think: true, Retry: false
[API End] 22.877s, Code: 200, Retry: 0
[Tokens] In: 66175, Out: 2, Total: 66177
[PDF Mode ERROR] ⚠️ 異常短回應: In: 66175, Out: 2, Content: "😎 "
```

**API 消耗了 66K tokens，卻只返回 2 tokens（一個 emoji）。**

這表示 API 請求內有某個部分導致 AI 無法正常回答。

## 🔍 診斷

檢查代碼第 2101-2108 行：

```javascript
// v24.5.8: Google Search 工具僅在 PDF 模式必要時啟用
let tools = undefined;
if (attachPDFs && !imageBlob) {
    tools = [{ google_search: {} }];  // ❌ Deep Mode 時啟用搜尋
}
```

**這是設計錯誤！** 當掛載 PDF 時啟用 Google Search 工具會導致：

1. **搜尋工具衝突**：AI 試圖同時從 PDF 和網路搜尋兩個來源獲取資訊
2. **超時問題**：搜尋工具調用緩慢，导致 API 在等待搜尋結果時耗盡時間預算
3. **響應截斷**：當搜尋失敗或超時，AI 被迫返回簡短回應或退落到 emoji
4. **Token 浪費**：66K tokens 用於搜尋嘗試，最終只返回 2 tokens

## ✅ 修復方案

**完全禁用 Deep Mode 的 Google Search 工具**：

```javascript
// v27.2.3: 修復 Deep Mode 搜尋工具導致空白回應
// 問題：在掛載 PDF 時啟用 Google Search，AI 試圖搜尋補充導致超時/失敗，最後只返回 emoji
// 解決：Deep Mode 禁用搜尋，專注於 PDF 內容。客戶端層級需要時可用 [AUTO_SEARCH_PDF] 重試

let tools = undefined;
// 搜尋工具現已禁用，因為：
// 1. Fast Mode: [AUTO_SEARCH_PDF] 可讓系統自動進 Deep Mode
// 2. Deep Mode: PDF 已足夠完整，搜尋反而造成混亂和超時
// if (attachPDFs && !imageBlob) {
//     tools = [{ google_search: {} }];
// }
```

## 📊 邏輯重新設計

### 原始設計（破損）
```
Fast Mode (規格問題) 
  → QA/CLASS_RULES 有答案 → 回答
  → QA/CLASS_RULES 無答案 → [AUTO_SEARCH_PDF]
  → Deep Mode，且啟用 Google Search ← ❌ 搜尋超時
```

### 修復後設計（正確）
```
Fast Mode (規格問題)
  → QA/CLASS_RULES 有答案 → 回答
  → QA/CLASS_RULES 無答案 → [AUTO_SEARCH_PDF]
  → Deep Mode，禁用搜尋，專注 PDF
     - 有 PDF 內容 → 直接回答（快速、確定）
     - 無 PDF 內容 → 說「手冊沒寫」，落實 v27.2.0 的 Fallback 機制
```

## 💡 為什麼搜尋工具在 Deep Mode 有害

| 場景 | 後果 |
|------|------|
| **API 試圖搜尋** | Google API 調用（延遲）+ 結果解析（額外處理）|
| **搜尋結果為空** | AI 陷入「PDF 說 X，網路沒說 → 怎麼辦」的困境 |
| **搜尋超時** | 時間預算用盡，AI 被強制中止，返回空白/Emoji |
| **Token 計數** | 搜尋工具的 input tokens 被計入總數，導致 66K 浪費 |

## 🎯 修復預期

**v27.2.3 後的 Deep Mode：**
- ✅ 禁用 Google Search 工具
- ✅ AI 專注於 PDF 內容
- ✅ 22.877s 的等待時間將用於讀 PDF，而非等搜尋
- ✅ 返回有意義的長篇回答，而非 Emoji

## 🚀 版本線

| 版本 | 修復內容 |
|------|----------|
| v27.2.0 | 邏輯重構（解除 Deep Mode 禁令） |
| v27.2.1 | 緊急修復：scope 錯誤 |
| v27.2.2 | 設計修復：/重啟 forceRebuild |
| **v27.2.3** | **致命修復：禁用 Deep Mode 搜尋工具** |

