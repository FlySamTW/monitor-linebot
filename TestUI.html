<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>LINE Debugger Pro v3.2</title>
  
  <!-- üî• Ê•µÈôêÁîüÂ≠òË£ú‰∏ÅÔºöÂº∑Âà∂Ê≥®ÂÖ• Mock Google Áâ©‰ª∂ (ÊîæÂú®ÊúÄÂâçÈù¢Âü∑Ë°å) -->
  <script>
    (function() {
      // Â¶ÇÊûúÂ∑≤Á∂ìÊúâ google.script.runÔºåÂ∞±‰ªÄÈ∫ºÈÉΩ‰∏çÂÅö (Ê≠£ÂºèÁí∞Â¢É)
      if (window.google && window.google.script && window.google.script.run) return;

      console.warn("üö® [Á≥ªÁµ±] Êú™ÂÅµÊ∏¨Âà∞ GAS Áí∞Â¢ÉÔºåÂïüÁî®Âº∑Âà∂ Mock Ê®°Âºè");
      window.isMockMode = true;

      window.google = {
        script: {
          run: {
            withSuccessHandler: function(fn) { this.success = fn; return this; },
            withFailureHandler: function(fn) { this.failure = fn; return this; },
            testMessage: function(msg, userId) {
              console.log("[MockÁôºÈÄÅ] " + msg);
              setTimeout(() => {
                if(this.success) {
                  this.success({
                    success: true,
                    replies: [
                      "[Mock] Êî∂Âà∞: " + msg, 
                      "(ÈÄôÊòØÊú¨Âú∞Ê®°Êì¨ÂõûÊáâÔºåË´ãÈÉ®ÁΩ≤Âà∞ GAS ‰ª•ÈÄ£Êé•ÁúüÂØ¶Â§ßËÖ¶)"
                    ],
                    logs: [
                      "[Mock Log] ËôïÁêÜË®äÊÅØ: " + msg,
                      "[Mock Log] Âü∑Ë°åÂÆåÁï¢"
                    ]
                  });
                }
              }, 800);
            },
            clearTestSession: function(userId) {
              console.log("[MockÊ∏ÖÈô§]");
              setTimeout(() => {
                if(this.success) this.success({ success: true, msg: "Mock Session Cleared" });
              }, 500);
            }
          }
        }
      };
    })();
  </script>

  <!-- ÂºïÂÖ• FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- CSS Ê®£Âºè (‰øùÊåÅ‰∏çËÆä) --- */
    :root {
      --line-bg: #8C9DAF;
      --line-header: #F5F5F5;
      --user-bubble: #95EC69;
      --bot-bubble: #FFFFFF;
      --text-color: #000000;
      --meta-color: #555555;
      --input-bg: #FFFFFF;
      --send-btn: #1E6BE5;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #202023;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .layout-container {
      display: flex;
      gap: 30px;
      height: 850px;
      max-height: 95vh;
      align-items: center;
    }

    /* ÊâãÊ©üÂ§ñÊ°Ü */
    .phone-wrapper {
      width: 390px;
      height: 844px;
      background: #000;
      border-radius: 50px;
      padding: 12px;
      box-shadow: 0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.5);
      position: relative;
      flex-shrink: 0;
    }

    .notch {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 30px;
      background: #000;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
      z-index: 100;
    }

    .screen {
      width: 100%;
      height: 100%;
      background-color: var(--line-bg);
      border-radius: 40px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* LINE Header */
    .line-header {
      background: rgba(245, 245, 245, 0.95);
      backdrop-filter: blur(10px);
      padding: 45px 15px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #dcdcdc;
      z-index: 10;
    }
    
    .header-title {
      font-size: 17px;
      font-weight: 600;
      color: #333;
      flex: 1;
      text-align: center;
      margin-left: -24px;
    }

    .mock-badge {
        font-size: 10px;
        background: #ff4444;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
        display: none; /* È†êË®≠Èö±Ëóè */
    }

    .back-btn, .menu-btn { font-size: 20px; color: #333; cursor: pointer; }

    /* ËÅäÂ§©ÂçÄÂüü */
    #chat-box {
      flex: 1;
      padding: 20px 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }

    .msg-row {
      display: flex;
      align-items: flex-end;
      max-width: 100%;
      position: relative;
      margin-bottom: 10px;
    }
    
    .msg-row.user { justify-content: flex-end; }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg');
      background-size: cover;
      margin-right: 8px;
      flex-shrink: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .msg-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
      box-shadow: 0 1px 1px rgba(0,0,0,0.05);
      position: relative;
    }

    .msg-row.bot .msg-bubble {
      background-color: var(--bot-bubble);
      border-top-left-radius: 4px;
      color: var(--text-color);
    }

    .msg-row.user .msg-bubble {
      background-color: var(--user-msg-bg);
      border-top-right-radius: 4px;
      color: var(--text-color);
    }

    .msg-meta {
      font-size: 10px;
      color: var(--meta-color);
      margin: 0 6px 5px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      min-width: 30px;
    }
    .msg-row.user .msg-meta { align-items: flex-end; text-align: right; }
    .msg-row.bot .msg-meta { align-items: flex-start; }
    
    .read-tag { color: #555; margin-bottom: 2px; }

    /* Ëº∏ÂÖ•ÂçÄ */
    .input-area {
      background: #fff;
      padding: 10px 15px 25px;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      border-top: 1px solid #eee;
    }

    .tool-btn { font-size: 24px; color: #999; cursor: pointer; padding-bottom: 5px; }

    #msg-input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 20px;
      border: 1px solid #ddd;
      background: #f7f7f7;
      outline: none;
      font-size: 16px;
      max-height: 100px;
      resize: none;
    }
    
    #send-btn {
      background: none;
      border: none;
      color: var(--send-btn);
      font-size: 24px;
      cursor: pointer;
      padding-bottom: 5px;
    }
    #send-btn:disabled { color: #ccc; }

    /* ‰ΩáÂàóÊ¢ù */
    #queue-bar {
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 15px;
      font-size: 11px;
      display: none;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(4px);
    }
    #queue-list { display: flex; gap: 6px; overflow-x: auto; flex: 1; }
    .queue-chip { background: #444; border-radius: 10px; padding: 2px 8px; white-space: nowrap; border: 1px solid #666;}

    /* ÊéßÂà∂Èù¢Êùø */
    .control-panel {
      width: 450px;
      height: 100%;
      background: #1e1e1e;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #444;
    }

    .panel-header {
      padding: 15px;
      background: #252526;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #ccc;
      font-weight: bold;
    }

    .log-box {
      flex: 1;
      background: #1e1e1e;
      padding: 10px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      color: #d4d4d4;
      line-height: 1.5;
    }
    .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    .log-ts { color: #888; margin-right: 8px; }
    .log-tag { color: #569cd6; font-weight: bold; }
    .log-err { color: #f48771; }

    .history-panel {
      height: 250px;
      background: #252526;
      border-top: 1px solid #333;
      display: flex;
      flex-direction: column;
    }
    .history-content {
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-content: flex-start;
    }
    .history-chip {
      background: #333; color: #ccc;
      border: 1px solid #555;
      padding: 6px 12px; border-radius: 20px;
      font-size: 13px; cursor: pointer;
      transition: 0.2s;
    }
    .history-chip:hover { background: #444; color: #fff; border-color: #888; }
    .history-chip.active { border-color: #06c755; color: #06c755; background: #1a3320; }

    .btn {
      background: #333; border: 1px solid #555; color: #ccc;
      padding: 5px 10px; border-radius: 6px; cursor: pointer;
      font-size: 12px; display: flex; align-items: center; gap: 5px;
    }
    .btn:hover { background: #444; color: #fff; }
    .btn-danger { background: #5a1e1e; border-color: #a00; color: #faa; }
    .btn-danger:hover { background: #a00; color: #fff; }

    .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

    @media (max-width: 900px) {
      body { background: #fff; height: auto; overflow: auto; display: block; }
      .layout-container { flex-direction: column; height: auto; gap: 0; }
      .phone-wrapper { width: 100%; height: 100vh; border-radius: 0; box-shadow: none; padding: 0; }
      .screen { border-radius: 0; }
      .notch { display: none; }
      .control-panel { width: 100%; height: 500px; border-radius: 0; }
    }
  </style>
</head>
<body>

<div class="layout-container">
  
  <!-- ÊâãÊ©üÊú¨È´î -->
  <div class="phone-wrapper">
    <div class="notch"></div>
    <div class="screen">
      <div class="line-header">
        <div class="back-btn"><i class="fas fa-chevron-left"></i></div>
        <div class="header-title">‰∏âÊòüËû¢ÂπïÂ∞èÂπ´Êâã <span id="mock-badge" class="mock-badge">MOCK</span></div>
        <div class="menu-btn"><i class="fas fa-bars"></i></div>
      </div>

      <div id="chat-box"></div>

      <div id="queue-bar">
        <i class="fas fa-hourglass-half"></i>
        <div id="queue-list"></div>
      </div>

      <div class="input-area">
        <div class="tool-btn"><i class="fas fa-plus"></i></div>
        <div class="tool-btn"><i class="fas fa-camera"></i></div>
        <div class="tool-btn"><i class="fas fa-image"></i></div>
        <input type="text" id="msg-input" placeholder="Aa" onkeydown="checkEnter(event)">
        <button id="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- ÊéßÂà∂Èù¢Êùø -->
  <div class="control-panel">
    <div class="panel-header">
      <span><i class="fas fa-terminal"></i> SYSTEM LOGS</span>
      <div style="display:flex; gap:5px;">
        <button class="btn" onclick="copyLogs()"><i class="far fa-copy"></i> Ë§áË£Ω</button>
        <button class="btn" onclick="clearLogUI()"><i class="fas fa-eraser"></i> Ê∏ÖÁ©∫</button>
        <button class="btn btn-danger" onclick="clearSession()"><i class="fas fa-trash-alt"></i> ÈáçÁΩÆ</button>
      </div>
    </div>
    
    <div id="log-box" class="log-box">
      <div class="log-line"><span class="log-tag">[System]</span> Á≠âÂæÖÊìç‰Ωú...</div>
    </div>

    <div class="panel-header" style="border-top:1px solid #333; padding: 10px 15px;">
      <span><i class="fas fa-history"></i> Âø´Êç∑/Ê≠∑Âè≤Êåá‰ª§</span>
      <button class="btn" onclick="clearHistory()" style="padding: 2px 8px; font-size: 11px;">Ê∏ÖÁ©∫</button>
    </div>
    <div class="history-panel">
      <div id="history-list" class="history-content"></div>
    </div>
  </div>

</div>

<script>
  // ÁãÄÊÖãÁÆ°ÁêÜ
  var messageQueue = []; 
  var isBotProcessing = false; 
  var sentHistory = new Set();
  var defaultCmds = ["/ÈáçÂïü", "/Á¥ÄÈåÑ Ê∏¨Ë©¶", "M8ÊúâË¶ñË®äÈè°È†≠Âóé", "ÈÇ£M9Âë¢", "M8ÊÄéÈ∫ºÁî®", "3"];

  window.onload = function() {
    // Ê™¢Êü•ÊòØÂê¶Âú® Mock Ê®°Âºè
    if (window.isMockMode) {
        document.getElementById('mock-badge').style.display = 'inline-block';
        addSystemMsg("‚ö†Ô∏è Ê≥®ÊÑèÔºöÁõÆÂâçÁÇ∫ Mock Ê®°Âºè (Êú™ÈÄ£Êé•ÂæåÁ´Ø)");
    } else {
        addSystemMsg("‚úÖ Ê®°Êì¨Âô®ÈÄ£Á∑öÊàêÂäü (GAS Mode)");
    }
    
    defaultCmds.forEach(addHistoryItem);
    addToQueue("/ÈáçÂïü");
  };

  // --- ÊéíÁ®ãÁ≥ªÁµ± ---
  function addToQueue(text) {
    if(!text) return;
    messageQueue.push(text);
    renderQueue();
    processQueue();
  }

  function processQueue() {
    if (isBotProcessing || messageQueue.length === 0) return;
    var nextMsg = messageQueue.shift();
    renderQueue();
    doSendMessage(nextMsg);
  }

  function renderQueue() {
    var bar = document.getElementById("queue-bar");
    var list = document.getElementById("queue-list");
    if (messageQueue.length === 0) {
      bar.style.display = "none";
      return;
    }
    bar.style.display = "flex";
    list.innerHTML = messageQueue.map((t, i) => `<div class="queue-chip">${i+1}. ${t}</div>`).join("");
  }

  // --- ÁôºÈÄÅÈÇèËºØ ---
  function sendMessage() {
    var input = document.getElementById("msg-input");
    var text = input.value.trim();
    if (!text) return;
    addToQueue(text);
    addHistoryItem(text);
    input.value = "";
  }

  function doSendMessage(text) {
    isBotProcessing = true;
    addMsg("user", text);
    var loadingId = addMsg("bot", "Reading..."); 

    try {
      google.script.run
        .withSuccessHandler(function(res) {
          isBotProcessing = false;
          removeMsg(loadingId);
          
          if (res.logs && res.logs.length > 0) updateLogs(res.logs);
          
          if (res.replies && Array.isArray(res.replies) && res.replies.length > 0) {
              res.replies.forEach((reply, idx) => {
                  setTimeout(() => {
                      addMsg("bot", reply);
                  }, idx * 200); 
              });
          } else {
              addMsg("bot", "(ÁÑ°ÂõûÊáâÊàñËß£ÊûêÂ§±Êïó)");
          }

          setTimeout(processQueue, 1000);
        })
        .withFailureHandler(function(err) {
          isBotProcessing = false;
          removeMsg(loadingId);
          addMsg("bot", "‚ùå Error: " + err);
          setTimeout(processQueue, 1000);
        })
        .testMessage(text, "TEST_DEV_001");
    } catch (e) {
      // ÈÄôË£°ÊáâË©≤‰∏çÊúÉÈÄ≤‰æÜ‰∫ÜÔºåÂõ†ÁÇ∫ÊàëÂÄëÊúâ Mock
      console.error("Critical Error:", e);
      isBotProcessing = false;
      removeMsg(loadingId);
      addMsg("bot", "‚ùå Client Error: " + e.message);
    }
  }

  // --- UI Ê∏≤Êüì ---
  function addMsg(role, text) {
    var chatBox = document.getElementById("chat-box");
    var time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    var html = "";
    if (role === "user") {
        html = `
        <div class="msg-row user">
            <div class="msg-meta">
                <span class="read-tag">Â∑≤ËÆÄ</span>
                <span class="time">${time}</span>
            </div>
            <div class="msg-bubble">${text}</div>
        </div>`;
    } else {
        html = `
        <div class="msg-row bot">
            <div class="avatar"></div>
            <div class="msg-bubble">${text}</div>
            <div class="msg-meta">
                <span class="time">${time}</span>
            </div>
        </div>`;
    }
    
    chatBox.insertAdjacentHTML('beforeend', html);
    chatBox.scrollTop = chatBox.scrollHeight;
    return "temp-id"; 
  }

  function addSystemMsg(text) {
    var chatBox = document.getElementById("chat-box");
    var html = `<div style="text-align:center; margin:10px; color:#fff; font-size:12px; background:rgba(0,0,0,0.2); padding:4px 10px; border-radius:10px; align-self:center;">${text}</div>`;
    chatBox.insertAdjacentHTML('beforeend', html);
  }

  function removeMsg(id) {
    var bubbles = document.querySelectorAll(".msg-bubble");
    if (bubbles.length > 0) {
        var last = bubbles[bubbles.length - 1];
        if (last.innerText.includes("Reading...")) {
            last.parentElement.remove();
        }
    }
  }

  function updateLogs(logs) {
    var logBox = document.getElementById("log-box");
    logs.forEach(line => {
      var html = `<div class="log-line">${line}</div>`;
      logBox.insertAdjacentHTML('beforeend', html);
    });
    logBox.scrollTop = logBox.scrollHeight;
  }

  function addHistoryItem(text) {
    if (sentHistory.has(text)) return;
    sentHistory.add(text);
    var container = document.getElementById("history-list");
    var chip = document.createElement("div");
    chip.className = "history-chip";
    chip.innerText = text;
    chip.onclick = function() {
      chip.classList.add("active");
      setTimeout(() => chip.classList.remove("active"), 200);
      addToQueue(text);
    };
    container.insertBefore(chip, container.firstChild);
  }

  function clearHistory() {
    sentHistory.clear();
    document.getElementById("history-list").innerHTML = "";
    defaultCmds.forEach(addHistoryItem);
  }

  function clearSession() {
    if(!confirm("Á¢∫ÂÆöÈáçÁΩÆÁ≥ªÁµ±ËàáË®òÊÜ∂Ôºü")) return;
    document.getElementById("chat-box").innerHTML = "";
    document.getElementById("log-box").innerHTML = "";
    messageQueue = [];
    renderQueue();
    isBotProcessing = false;
    google.script.run.clearTestSession("TEST_DEV_001");
    addSystemMsg("Á≥ªÁµ±Â∑≤ÈáçÁΩÆ");
  }

  function copyLogs() {
    navigator.clipboard.writeText(document.getElementById("log-box").innerText);
    alert("Logs Â∑≤Ë§áË£Ω");
  }
  function clearLogUI() { document.getElementById("log-box").innerHTML = ""; }
  function checkEnter(e) { if(e.key === "Enter") sendMessage(); }

</script>
</body>
</html>