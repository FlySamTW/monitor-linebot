<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>LINE 模擬器 V3.0</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --line-bg: #dfe6ec;
      --line-header: #f7f8f9;
      --user-bubble: #95ec69;
      --bot-bubble: #ffffff;
      --text-color: #0f1419;
      --meta-color: #6b6b6b;
      --send-btn: #1e6be5;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at 20% 20%, #f0f2f5, #c9d1d9);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .layout-container {
      display: flex;
      gap: 28px;
      height: 880px;
      max-height: 95vh;
      align-items: center;
    }

    .phone-wrapper {
      width: 392px;
      height: 852px;
      background: #000;
      border-radius: 46px;
      padding: 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35), 0 0 0 2px #333;
      position: relative;
      flex-shrink: 0;
    }

    .notch {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 30px;
      background: #000;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
      z-index: 10;
    }

    .screen {
      width: 100%;
      height: 100%;
      background: var(--line-bg);
      border-radius: 36px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .line-header {
      background: rgba(247, 248, 249, 0.95);
      backdrop-filter: blur(10px);
      padding: 46px 16px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e2e2e2;
      z-index: 5;
    }
    .header-title {
      font-size: 17px;
      font-weight: 700;
      color: #222;
      flex: 1;
      text-align: center;
      margin-left: -24px;
    }
    .back-btn, .menu-btn { font-size: 20px; color: #222; cursor: pointer; }

    #chat-box {
      flex: 1;
      padding: 18px 12px 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .system-tip {
      align-self: center;
      color: #5b6166;
      font-size: 12px;
      background: rgba(0,0,0,0.08);
      padding: 6px 12px;
      border-radius: 14px;
      margin-top: 4px;
    }

    .msg-row {
      display: flex;
      align-items: flex-end;
      max-width: 100%;
      gap: 6px;
    }
    .msg-row.user { justify-content: flex-end; }

    .avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: url('https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg') center/cover no-repeat;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }

    .msg-bubble {
      max-width: 74%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .msg-row.bot .msg-bubble {
      background: var(--bot-bubble);
      border-top-left-radius: 6px;
      color: var(--text-color);
    }
    .msg-row.user .msg-bubble {
      background: var(--user-bubble);
      border-top-right-radius: 6px;
      color: #0b1a04;
    }

    .msg-meta {
      font-size: 10px;
      color: var(--meta-color);
      min-width: 38px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .msg-row.user .msg-meta { align-items: flex-end; }
    .msg-row.bot .msg-meta { align-items: flex-start; }
    .read-tag { color: #5c5c5c; }

    .input-area {
      background: #fff;
      padding: 12px 14px 22px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-top: 1px solid #ececec;
    }
    .tool-btn { font-size: 22px; color: #9c9c9c; cursor: pointer; }

    #msg-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 18px;
      border: 1px solid #d8d8d8;
      background: #f7f7f7;
      outline: none;
      font-size: 16px;
    }
    #send-btn {
      background: none;
      border: none;
      color: var(--send-btn);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 6px;
    }
    #send-btn:disabled { color: #c9c9c9; }

    #queue-bar {
      background: rgba(0,0,0,0.65);
      color: #fff;
      padding: 6px 12px;
      font-size: 11px;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(6px);
    }
    #queue-list { display: flex; gap: 6px; overflow-x: auto; flex: 1; }
    .queue-chip { background: #444; border-radius: 9px; padding: 2px 8px; white-space: nowrap; border: 1px solid #666; }

    .control-panel {
      width: 460px;
      height: 100%;
      background: #1e1e1e;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #3a3a3a;
      box-shadow: 0 10px 26px rgba(0,0,0,0.28);
    }
    .panel-header {
      padding: 14px 16px;
      background: #252526;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #d8d8d8;
      font-weight: bold;
    }
    .log-box {
      flex: 1;
      background: #1e1e1e;
      padding: 10px;
      overflow-y: auto;
      font-family: Consolas, Monaco, monospace;
      font-size: 12px;
      color: #d4d4d4;
      line-height: 1.5;
    }
    .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    .history-panel { height: 250px; background: #252526; border-top: 1px solid #333; display: flex; flex-direction: column; }
    .history-content { padding: 10px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start; }
    .history-chip { background: #333; color: #ccc; border: 1px solid #555; padding: 6px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .history-chip:hover { background: #444; color: #fff; border-color: #888; }
    .history-chip.active { border-color: #06c755; color: #06c755; background: #1a3320; }

    .btn { background: #333; border: 1px solid #555; color: #ccc; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
    .btn:hover { background: #444; color: #fff; }
    .btn-danger { background: #5a1e1e; border-color: #a00; color: #f7bbbb; }
    .btn-danger:hover { background: #a00; color: #fff; }

    .loading-dots::after { content: '…'; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }

    @media (max-width: 900px) {
      body { background: #fff; display: block; overflow: auto; }
      .layout-container { flex-direction: column; height: auto; gap: 10px; }
      .phone-wrapper { width: 100%; height: 100vh; border-radius: 0; box-shadow: none; padding: 0; }
      .screen { border-radius: 0; }
      .notch { display: none; }
      .control-panel { width: 100%; height: 520px; border-radius: 0; }
    }
  </style>
</head>
<body>

<div class="layout-container">
  <div class="phone-wrapper">
    <div class="notch"></div>
    <div class="screen">
      <div class="line-header">
        <div class="back-btn"><i class="fas fa-chevron-left"></i></div>
        <div class="header-title">三星螢幕小幫手</div>
        <div class="menu-btn"><i class="fas fa-bars"></i></div>
      </div>

      <div id="chat-box"></div>

      <div id="queue-bar">
        <i class="fas fa-hourglass-half"></i>
        <div id="queue-list"></div>
      </div>

      <div class="input-area">
        <div class="tool-btn"><i class="fas fa-plus"></i></div>
        <div class="tool-btn"><i class="fas fa-camera"></i></div>
        <div class="tool-btn"><i class="fas fa-image"></i></div>
        <input type="text" id="msg-input" placeholder="Aa" onkeydown="checkEnter(event)">
        <button id="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div class="control-panel">
    <div class="panel-header">
      <span><i class="fas fa-terminal"></i> SYSTEM LOGS</span>
      <div style="display:flex; gap:6px;">
        <button class="btn" onclick="copyLogs()"><i class="far fa-copy"></i> 複製</button>
        <button class="btn" onclick="clearLogUI()"><i class="fas fa-eraser"></i> 清空</button>
        <button class="btn btn-danger" onclick="clearSession()"><i class="fas fa-trash-alt"></i> 重置</button>
      </div>
    </div>

    <div id="log-box" class="log-box">
      <div class="log-line">[System] 等待操作...</div>
    </div>

    <div class="panel-header" style="border-top:1px solid #333; padding: 10px 16px;">
      <span><i class="fas fa-history"></i> 快捷/歷史指令</span>
      <button class="btn" onclick="clearHistory()" style="padding: 2px 8px; font-size: 11px;">清空</button>
    </div>
    <div class="history-panel">
      <div id="history-list" class="history-content"></div>
    </div>
  </div>
</div>

<script>
  var messageQueue = [];
  var isBotProcessing = false;
  var sentHistory = new Set();
  var defaultCmds = ["/重啟", "/紀錄 測試", "M8有視訊鏡頭嗎", "那M9呢", "M8怎麼用", "3"];

  window.onload = function() {
    addSystemMsg("模擬器連線成功 (v3.0)");
    defaultCmds.forEach(addHistoryItem);
    addToQueue("/重啟");
  };

  function addToQueue(text) {
    if(!text) return;
    messageQueue.push(text);
    renderQueue();
    processQueue();
  }

  function processQueue() {
    if (isBotProcessing || messageQueue.length === 0) return;
    var nextMsg = messageQueue.shift();
    renderQueue();
    doSendMessage(nextMsg);
  }

  function renderQueue() {
    var bar = document.getElementById("queue-bar");
    var list = document.getElementById("queue-list");
    if (messageQueue.length === 0) {
      bar.style.display = "none";
      return;
    }
    bar.style.display = "flex";
    list.innerHTML = messageQueue.map((t, i) => `<div class="queue-chip">${i+1}. ${t}</div>`).join("");
  }

  function sendMessage() {
    var input = document.getElementById("msg-input");
    var text = input.value.trim();
    if (!text) return;
    addToQueue(text);
    addHistoryItem(text);
    input.value = "";
  }

  function doSendMessage(text) {
    isBotProcessing = true;
    addMsg("user", text);
    var loadingId = addMsg("bot", "讀取中", { loading: true });

    google.script.run
      .withSuccessHandler(function(res) {
        isBotProcessing = false;
        removeMsg(loadingId);

        if (res.logs && res.logs.length > 0) updateLogs(res.logs);

        if (res.replies && Array.isArray(res.replies) && res.replies.length > 0) {
            res.replies.forEach(function(reply, idx) {
                setTimeout(function() { addMsg("bot", reply); }, idx * 220);
            });
        } else {
            addMsg("bot", "(無回應或解析失敗)");
        }

        setTimeout(processQueue, 800);
      })
      .withFailureHandler(function(err) {
        isBotProcessing = false;
        removeMsg(loadingId);
        addMsg("bot", "❌ Error: " + err);
        setTimeout(processQueue, 800);
      })
      .testMessage(text, "TEST_DEV_001");
  }

  function addMsg(role, text, options) {
    options = options || {};
    var chatBox = document.getElementById("chat-box");
    var time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    var id = `msg-${Date.now()}-${Math.floor(Math.random()*10000)}`;

    var bubble = `<div class="msg-bubble ${options.loading ? 'loading-dots' : ''}">${text}</div>`;
    var metaUser = `<div class="msg-meta"><span class="read-tag">已讀</span><span class="time">${time}</span></div>`;
    var metaBot = `<div class="msg-meta"><span class="time">${time}</span></div>`;

    var html = "";
    if (role === "user") {
      html = `<div class="msg-row user" id="${id}">${metaUser}${bubble}</div>`;
    } else {
      html = `<div class="msg-row bot" id="${id}"><div class="avatar"></div>${bubble}${metaBot}</div>`;
    }

    chatBox.insertAdjacentHTML('beforeend', html);
    chatBox.scrollTop = chatBox.scrollHeight;
    return id;
  }

  function removeMsg(id) {
    var row = document.getElementById(id);
    if (row) row.remove();
  }

  function addSystemMsg(text) {
    var chatBox = document.getElementById("chat-box");
    chatBox.insertAdjacentHTML('beforeend', `<div class="system-tip">${text}</div>`);
  }

  function updateLogs(logs) {
    var logBox = document.getElementById("log-box");
    logs.forEach(function(line) {
      logBox.insertAdjacentHTML('beforeend', `<div class="log-line">${line}</div>`);
    });
    logBox.scrollTop = logBox.scrollHeight;
  }

  function addHistoryItem(text) {
    if (sentHistory.has(text)) return;
    sentHistory.add(text);
    var container = document.getElementById("history-list");
    var chip = document.createElement("div");
    chip.className = "history-chip";
    chip.innerText = text;
    chip.onclick = function() {
      chip.classList.add("active");
      setTimeout(function() { chip.classList.remove("active"); }, 200);
      addToQueue(text);
    };
    container.insertBefore(chip, container.firstChild);
  }

  function clearHistory() {
    sentHistory.clear();
    document.getElementById("history-list").innerHTML = "";
    defaultCmds.forEach(addHistoryItem);
  }

  function clearSession() {
    if(!confirm("確定重置系統與記憶？")) return;
    document.getElementById("chat-box").innerHTML = "";
    document.getElementById("log-box").innerHTML = "";
    messageQueue = [];
    renderQueue();
    isBotProcessing = false;
    google.script.run.clearTestSession("TEST_DEV_001");
    addSystemMsg("系統已重置");
  }

  function copyLogs() {
    navigator.clipboard.writeText(document.getElementById("log-box").innerText);
    alert("Logs 已複製");
  }

  function clearLogUI() { document.getElementById("log-box").innerHTML = ""; }
  function checkEnter(e) { if(e.key === "Enter") sendMessage(); }
</script>
</body>
</html>