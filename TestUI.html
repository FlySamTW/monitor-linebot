<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LINE Bot æ¸¬è©¦ä»‹é¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* é ‚éƒ¨æ¨™é¡Œ */
    .header {
      background: #06c755;
      color: white;
      padding: 12px 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header-title {
      font-size: 16px;
    }
    
    .header-info {
      font-size: 12px;
      opacity: 0.9;
    }
    
    /* ä¸»è¦å®¹å™¨ */
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* å·¦å´ï¼šå°è©±å€ (60%) */
    .chat-panel {
      flex: 0 0 60%;
      display: flex;
      flex-direction: column;
      background: white;
      border-right: 1px solid #ddd;
    }
    
    /* å°è©±å®¹å™¨ */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f0f0f0;
    }
    
    /* è¨Šæ¯æ°£æ³¡ */
    .message {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
    }
    
    .message.user {
      align-items: flex-end;
    }
    
    .message.bot {
      align-items: flex-start;
    }
    
    .bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 12px;
      word-wrap: break-word;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.5;
      user-select: text;
      cursor: text;
    }
    
    .message.user .bubble {
      background: #06c755;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .message.bot .bubble {
      background: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
    }
    
    .time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 4px;
    }
    
    /* è¼¸å…¥å€ */
    .input-area {
      padding: 12px;
      background: white;
      border-top: 1px solid #ddd;
    }
    
    .quick-commands {
      margin-bottom: 8px;
    }
    
    .quick-commands select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      cursor: pointer;
    }
    
    .input-row {
      display: flex;
      gap: 8px;
    }
    
    .input-row input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }
    
    .input-row input:focus {
      border-color: #06c755;
    }
    
    .input-row button {
      padding: 10px 20px;
      background: #06c755;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .input-row button:hover {
      background: #05b34a;
    }
    
    .input-row button:active {
      background: #049e40;
    }
    
    .input-row button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* å³å´ï¼šLOG å€ (40%) */
    .log-panel {
      flex: 0 0 40%;
      display: flex;
      flex-direction: column;
      background: #2d2d2d;
    }
    
    .log-header {
      padding: 12px;
      background: #1e1e1e;
      color: white;
      font-size: 13px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
    }
    
    .token-info {
      font-size: 12px;
      color: #4ec9b0;
      font-weight: normal;
    }
    
    .log-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #d4d4d4;
      user-select: text;
      cursor: text;
    }
    
    .log-entry {
      margin-bottom: 4px;
      word-wrap: break-word;
    }
    
    .log-entry.error {
      color: #f48771;
    }
    
    .log-entry.warning {
      color: #dcdcaa;
    }
    
    .log-entry.success {
      color: #4ec9b0;
    }
    
    /* æŒ‰éˆ•å€ */
    .button-row {
      padding: 12px;
      background: #1e1e1e;
      border-top: 1px solid #444;
      display: flex;
      gap: 8px;
    }
    
    .button-row button {
      flex: 1;
      padding: 8px;
      border: 1px solid #555;
      background: #3c3c3c;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .button-row button:hover {
      background: #4c4c4c;
      border-color: #666;
    }
    
    .button-row button:active {
      background: #2c2c2c;
    }
    
    .button-row button.danger {
      border-color: #d32f2f;
      color: #ff6b6b;
    }
    
    .button-row button.danger:hover {
      background: #5c1f1f;
    }
    
    /* è¼‰å…¥ä¸­ */
    .loading {
      text-align: center;
      padding: 20px;
      color: #999;
      font-size: 13px;
    }
    
    /* æ»¾å‹•æ¢æ¨£å¼ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    .log-container::-webkit-scrollbar-track {
      background: #1e1e1e;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* ç©ºç‹€æ…‹æç¤º */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 14px;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <!-- é ‚éƒ¨æ¨™é¡Œ -->
  <div class="header">
    <div class="header-title">ğŸ§ª LINE Bot æ¸¬è©¦ä»‹é¢</div>
    <div class="header-info" id="userInfo">User: TEST_DEV_001</div>
  </div>
  
  <!-- ä¸»è¦å®¹å™¨ -->
  <div class="container">
    <!-- å·¦å´ï¼šå°è©±å€ -->
    <div class="chat-panel">
      <div class="chat-container" id="chatContainer">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’¬</div>
          <div>é–‹å§‹æ¸¬è©¦å°è©±å§ï¼</div>
          <div style="font-size: 12px; margin-top: 8px; color: #bbb;">
            è¼¸å…¥è¨Šæ¯æˆ–ä½¿ç”¨å¿«æ·æŒ‡ä»¤
          </div>
        </div>
      </div>
      
      <div class="input-area">
        <div class="quick-commands">
          <select id="quickCommand" onchange="insertCommand()">
            <option value="">-- å¿«æ·æŒ‡ä»¤ --</option>
            <option value="/é‡å•Ÿ">/é‡å•Ÿ - é‡æ–°é–‹å§‹å°è©±</option>
            <option value="/ç´€éŒ„ ">/ç´€éŒ„ [å…§å®¹] - é€²å…¥å»ºæª”æ¨¡å¼</option>
            <option value="/å–æ¶ˆ">/å–æ¶ˆ - é€€å‡ºå»ºæª”æ¨¡å¼</option>
            <option value="1">1 - é¸æ“‡é¸é … 1</option>
            <option value="2">2 - é¸æ“‡é¸é … 2</option>
            <option value="3">3 - é¸æ“‡é¸é … 3</option>
            <option value="G8">G8 - æ¸¬è©¦å‹è™Ÿè¾¨è­˜</option>
            <option value="M8">M8 - æ¸¬è©¦å‹è™Ÿè¾¨è­˜</option>
            <option value="ä»€éº¼æ˜¯HDR">ä»€éº¼æ˜¯HDR - æ¸¬è©¦é€šç”¨çŸ¥è­˜</option>
            <option value="G80SDæ€éº¼èª¿äº®åº¦">G80SDæ€éº¼èª¿äº®åº¦ - æ¸¬è©¦PDFæœå°‹</option>
          </select>
        </div>
        
        <div class="input-row">
          <input 
            type="text" 
            id="messageInput" 
            placeholder="è¼¸å…¥è¨Šæ¯..." 
            onkeypress="handleKeyPress(event)"
            autocomplete="off"
          />
          <button onclick="sendMessage()" id="sendBtn">é€å‡º</button>
        </div>
      </div>
    </div>
    
    <!-- å³å´ï¼šLOG å€ -->
    <div class="log-panel">
      <div class="log-header">
        <span>ğŸ“Š åŸ·è¡Œæ—¥èªŒ</span>
        <span class="token-info" id="tokenInfo">Token: -</span>
      </div>
      
      <div class="log-container" id="logContainer">
        <div class="log-entry" style="color: #4ec9b0;">
          [ç³»çµ±] æ¸¬è©¦ä»‹é¢å·²å°±ç·’
        </div>
        <div class="log-entry" style="color: #888;">
          [æç¤º] æ­¤ä»‹é¢ä¸æœƒå½±éŸ¿æ­£å¼ LINE Bot é‹ä½œ
        </div>
        <div class="log-entry" style="color: #888;">
          [æç¤º] æ¸¬è©¦è³‡æ–™ä¸æœƒå¯«å…¥ã€Œæ‰€æœ‰ç´€éŒ„ã€Sheet
        </div>
      </div>
      
      <div class="button-row">
        <button onclick="copyLogs()">ğŸ“‹ è¤‡è£½ LOG</button>
        <button onclick="copyChat()">ğŸ“‹ è¤‡è£½å°è©±</button>
        <button onclick="clearAll()" class="danger">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
      </div>
    </div>
  </div>
  
  <script>
    const TEST_USER_ID = 'TEST_DEV_001';
    let messageCount = 0;
    
    // æ’å…¥å¿«æ·æŒ‡ä»¤
    function insertCommand() {
      const select = document.getElementById('quickCommand');
      const input = document.getElementById('messageInput');
      const cmd = select.value;
      
      if (cmd) {
        input.value = cmd;
        input.focus();
        select.selectedIndex = 0;
      }
    }
    
    // Enter éµé€å‡º
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
    
    // é€å‡ºè¨Šæ¯
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      // ç¦ç”¨æŒ‰éˆ•
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'è™•ç†ä¸­...';
      
      // æ¸…ç©ºè¼¸å…¥æ¡†
      input.value = '';
      
      // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
      addMessage('user', text);
      
      // æ¸…ç©ºä¹‹å‰çš„ LOGï¼ˆå¦‚æœéœ€è¦ä¿ç•™æ­·å² LOGï¼Œç§»é™¤é€™è¡Œï¼‰
      document.getElementById('logContainer').innerHTML = '';
      
      // å‘¼å«å¾Œç«¯
      google.script.run
        .withSuccessHandler(handleResponse)
        .withFailureHandler(handleError)
        .testMessage(TEST_USER_ID, text);
    }
    
    // è™•ç†å›æ‡‰
    function handleResponse(data) {
      // é¡¯ç¤º Bot å›æ‡‰
      addMessage('bot', data.text);
      
      // é¡¯ç¤º LOG
      if (data.logs && data.logs.length > 0) {
        const logContainer = document.getElementById('logContainer');
        data.logs.forEach(log => {
          const div = document.createElement('div');
          div.className = 'log-entry';
          
          // æ ¹æ“šå…§å®¹è¨­å®šé¡è‰²
          if (log.includes('ERROR') || log.includes('Error')) {
            div.className += ' error';
          } else if (log.includes('WARNING') || log.includes('Warning')) {
            div.className += ' warning';
          } else if (log.includes('SUCCESS') || log.includes('å®Œæˆ')) {
            div.className += ' success';
          }
          
          div.textContent = log;
          logContainer.appendChild(div);
        });
        
        // æ»¾å‹•åˆ°åº•éƒ¨
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      // é¡¯ç¤º Token è³‡è¨Š
      document.getElementById('tokenInfo').textContent = data.tokenInfo || 'Token: -';
      
      // æ¢å¾©æŒ‰éˆ•
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = false;
      sendBtn.textContent = 'é€å‡º';
      
      // èšç„¦è¼¸å…¥æ¡†
      document.getElementById('messageInput').focus();
    }
    
    // è™•ç†éŒ¯èª¤
    function handleError(error) {
      addMessage('bot', 'âŒ ç³»çµ±éŒ¯èª¤: ' + error.message);
      
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = false;
      sendBtn.textContent = 'é€å‡º';
      
      // LOG å€é¡¯ç¤ºéŒ¯èª¤
      const logContainer = document.getElementById('logContainer');
      const div = document.createElement('div');
      div.className = 'log-entry error';
      div.textContent = '[ERROR] ' + error.message;
      logContainer.appendChild(div);
    }
    
    // æ–°å¢è¨Šæ¯åˆ°å°è©±å€
    function addMessage(role, text) {
      const container = document.getElementById('chatContainer');
      
      // ç§»é™¤ç©ºç‹€æ…‹æç¤º
      const emptyState = container.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ' + role;
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      
      const time = document.createElement('div');
      time.className = 'time';
      const now = new Date();
      time.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.appendChild(bubble);
      messageDiv.appendChild(time);
      container.appendChild(messageDiv);
      
      // æ»¾å‹•åˆ°åº•éƒ¨
      container.scrollTop = container.scrollHeight;
      
      messageCount++;
    }
    
    // è¤‡è£½ LOG
    function copyLogs() {
      const logContainer = document.getElementById('logContainer');
      const logs = logContainer.innerText;
      
      if (!logs.trim()) {
        alert('æ²’æœ‰ LOG å¯è¤‡è£½');
        return;
      }
      
      navigator.clipboard.writeText(logs).then(() => {
        alert('âœ… LOG å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      }).catch(err => {
        alert('âŒ è¤‡è£½å¤±æ•—: ' + err);
      });
    }
    
    // è¤‡è£½å°è©±
    function copyChat() {
      const container = document.getElementById('chatContainer');
      const messages = container.querySelectorAll('.message');
      
      if (messages.length === 0) {
        alert('æ²’æœ‰å°è©±å¯è¤‡è£½');
        return;
      }
      
      let text = '';
      messages.forEach(msg => {
        const role = msg.classList.contains('user') ? 'æˆ‘' : 'Bot';
        const content = msg.querySelector('.bubble').textContent;
        const time = msg.querySelector('.time').textContent;
        text += `[${time}] ${role}: ${content}\n\n`;
      });
      
      navigator.clipboard.writeText(text).then(() => {
        alert('âœ… å°è©±å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      }).catch(err => {
        alert('âŒ è¤‡è£½å¤±æ•—: ' + err);
      });
    }
    
    // æ¸…é™¤å…¨éƒ¨
    function clearAll() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„å’Œ LOG å—ï¼Ÿ\n\né€™æœƒæ¸…é™¤å¿«å–ä¸­çš„å°è©±æ­·å²ï¼ˆä¸å½±éŸ¿ LINE æ­£å¼è³‡æ–™ï¼‰')) {
        return;
      }
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­
      const chatContainer = document.getElementById('chatContainer');
      chatContainer.innerHTML = '<div class="loading">æ¸…é™¤ä¸­...</div>';
      
      // å‘¼å«å¾Œç«¯æ¸…é™¤
      google.script.run
        .withSuccessHandler(() => {
          // æ¸…ç©ºå°è©±å€
          chatContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ’¬</div>
              <div>å·²æ¸…é™¤ï¼é–‹å§‹æ–°çš„æ¸¬è©¦å°è©±å§ï¼</div>
            </div>
          `;
          
          // æ¸…ç©º LOG å€
          document.getElementById('logContainer').innerHTML = `
            <div class="log-entry" style="color: #4ec9b0;">
              [ç³»çµ±] æ¸¬è©¦è¨˜éŒ„å·²æ¸…é™¤
            </div>
          `;
          
          // é‡ç½® Token è³‡è¨Š
          document.getElementById('tokenInfo').textContent = 'Token: -';
          
          // é‡ç½®è¨ˆæ•¸
          messageCount = 0;
          
          alert('âœ… æ¸…é™¤å®Œæˆï¼');
        })
        .withFailureHandler((error) => {
          alert('âŒ æ¸…é™¤å¤±æ•—: ' + error.message);
          chatContainer.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">âš ï¸</div>
              <div>æ¸…é™¤å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>
            </div>
          `;
        })
        .clearTestSession(TEST_USER_ID);
    }
    
    // é é¢è¼‰å…¥å®Œæˆ
    window.onload = function() {
      document.getElementById('messageInput').focus();
      console.log('LINE Bot æ¸¬è©¦ä»‹é¢å·²è¼‰å…¥');
    };
  </script>
</body>
</html>
